(this["webpackJsonpsupport-chat-widget"]=this["webpackJsonpsupport-chat-widget"]||[]).push([[2],{0:function(e,t,a){"use strict";var n=a(3),r=a(4),i=function(){function e(t){Object(n.a)(this,e),this.name="",this.worker=null,null==t&&(t="Request "+e.nextID++),this.name=t}return Object(r.a)(e,[{key:"invoke",value:function(e){var t=this;return new Promise((function(a,n){t.worker?t.worker(e,a):console.error("".concat(t.name," -> Worker no regisered yet"))}))}},{key:"listener",set:function(e){this.worker=e}}]),e}();i.nextID=0;var s=a(6),o=function(){function e(t){Object(n.a)(this,e),this.name="",this.methods=new Map,this.delayedAdd=[],this.delayedRemove=[],this.delayedContextClear=[],this.delayedInvoke=[],this.isDisposing=!1,this.isInvoking=!1,this.name=t,this.name=null==t?"signal "+e.nextID++:t}return Object(r.a)(e,[{key:"add",value:function(e,t){if(this.isDisposing)return null;if(this.isInvoking&&this.delayedAdd){var a,n=Object(s.a)(this.delayedAdd);try{for(n.s();!(a=n.n()).done;){if(a.value.cb===e)return e}}catch(o){n.e(o)}finally{n.f()}return this.delayedAdd.push({cb:e,ctx:t}),e}if(this.methods){var r,i=Object(s.a)(this.methods);try{for(i.s();!(r=i.n()).done;){if(r.value[0]===e)return console.warn("method already exitst"),e}}catch(o){i.e(o)}finally{i.f()}this.methods.set(e,t)}return e}},{key:"remove",value:function(e){if(!this.isDisposing)if(!0===this.isInvoking&&this.delayedRemove){var t,a=Object(s.a)(this.delayedRemove);try{for(a.s();!(t=a.n()).done;){if(t.value===e)return}}catch(n){a.e(n)}finally{a.f()}this.delayedRemove.push(e)}else this.methods&&this.methods.delete(e)}},{key:"clearContext",value:function(e){if(this.isInvoking&&this.delayedContextClear)this.delayedContextClear.push(e);else if(this.methods){var t,a=Object(s.a)(this.methods);try{for(a.s();!(t=a.n()).done;){var n=t.value;n[1]===e&&this.methods.delete(n[0])}}catch(r){a.e(r)}finally{a.f()}}}},{key:"invoke",value:function(e){if(!this.isDisposing&&this.methods){if(this.isInvoking&&this.delayedInvoke)return this.delayedInvoke.push(e),void console.warn("Signal already invoking "+this.name);this.isInvoking=!0;var t,a=Object(s.a)(this.methods);try{for(a.s();!(t=a.n()).done;){var n=t.value;if(null!=n[0])if("function"==typeof n[0])try{null!=n[1]?n[0].call(n[1],e):n[0].call(n[0],e)}catch(v){console.error(v)}else console.error("Can`t invoke method for signal: "+this.name);else this.methods.delete(n[0])}}catch(_){a.e(_)}finally{a.f()}if(this.isInvoking=!1,this.isDisposing)this.dispose();else{if(this.delayedRemove&&this.delayedRemove.length>0){var r,i=Object(s.a)(this.delayedRemove);try{for(i.s();!(r=i.n()).done;){var o=r.value;this.remove(o)}}catch(_){i.e(_)}finally{i.f()}this.delayedRemove=[]}if(this.delayedAdd&&this.delayedAdd.length>0){var c,u=Object(s.a)(this.delayedAdd);try{for(u.s();!(c=u.n()).done;){var l=c.value;l&&this.add(l.cb,l.ctx)}}catch(_){u.e(_)}finally{u.f()}this.delayedAdd=[]}if(this.delayedContextClear&&this.delayedContextClear.length>0){var h,d=Object(s.a)(this.delayedContextClear);try{for(d.s();!(h=d.n()).done;){var f=h.value;this.clearContext(f[1])}}catch(_){d.e(_)}finally{d.f()}this.delayedContextClear=[]}if(this.delayedInvoke&&this.delayedInvoke.length>0){var p=this.delayedInvoke.shift();p&&this.invoke(p)}}}}},{key:"dispose",value:function(){this.isDisposing||this.isInvoking||(this.isDisposing=!0,this.name=void 0,this.methods&&this.methods.clear(),this.methods=void 0,this.delayedAdd=void 0,this.delayedRemove=void 0,this.delayedContextClear=void 0)}}]),e}();o.nextID=1;var c=function e(){Object(n.a)(this,e)};c.S_APP_READY=new o,c.S_LOGOUT=new o,c.REQ_HTTP=new i("REQ_HTTP"),c.REQ_CONFIG_SCHEMES=new i("REQ_CONFIG_SCHEMES"),c.REQ_IMAGE_UPLOAD=new i("REQ_IMAGE_UPLOAD"),c.REQ_IMAGE_UPLOAD_AS_B64=new i("REQ_IMAGE_UPLOAD"),c.REQ_IMAGE_GET=new i("REQ_IMAGE_GET"),c.REQ_FILE_UPLOAD=new i("REQ_FILE_UPLOAD"),c.REQ_SECURITY_KEY=new i("REQ_SECURITY_KEY"),c.REQ_CHAT=new i("REQ_SECURITY_KEY"),c.REQ_MESSAGE_PARSE_FROM_CHAT=new i("REQ_MESSAGE_PARSE_FROM_CHAT"),c.REQ_CURRENT_CHAT=new i("REQ_CURRENT_CHAT"),c.REQ_CURRENT_PROFILE=new i("REQ_CURRENT_PROFILE"),c.REQ_WS_STATUS=new i("REQ_CURRENT_PROFILE"),c.REQ_FILE_PREVIEW_GET_BY_UID=new i("REQ_FILE_PREVIEW_GET_BY_UID"),c.REQ_TOASTS=new i("REQ_TOASTS"),c.REQ_LAST_READ_MSG=new i("REQ_LAST_READ_MSG"),c.REQ_USERS_IN_CHAT=new i("REQ_USERS_IN_CHAT"),c.REQ_USERS_STATUS=new i("REQ_USERS_STATUS"),c.S_FILE_DOWNLOAD_REQUEST=new o,c.S_FILE_STOP_UPLOAD=new o,c.S_FILE_START_UPLOAD=new o,c.S_FILE_UPLOADING_LIST_UPDATED=new o,c.S_FILE_PREVIEW_ATTACH=new o,c.S_FILE_PREVIEW_DELETE=new o,c.S_FILE_PREVIEW_DELETE_ALL=new o,c.S_SERVICE_READY=new o,c.S_AUTH_ERROR=new o,c.S_AUTH_REQUEST=new o,c.S_AUTH_COMPLETE=new o,c.S_AUTH_CHECK=new o,c.S_AUTH_REQUEST_BY_PHONE=new o,c.S_AUTH_CHECK_CODE=new o,c.S_AUTH_CODE_REQUESTED=new o,c.S_NEED_AUTHENTICATE=new o,c.S_REQUEST_AUTHENTICATE=new o,c.S_CHAT_OPENED=new o,c.S_CHAT_MESSAGES=new o,c.S_CHAT_MESSAGE_SEND_REQUEST=new o,c.S_CHAT_BOT_COMMAND_SEND_REQUEST=new o,c.S_CHAT_FILE_SEND_REQUEST=new o,c.S_CHAT_OPEN_REQUEST=new o,c.S_CHAT_OPENING=new o,c.S_CHAT_SCREENSHOT_SEND_REQUEST=new o,c.S_MESSAGE_ADDED=new o,c.S_MESSAGE_READ=new o,c.S_LATEST_READY=new o,c.S_LATEST_REQUEST=new o,c.S_TOAST=new o,c.S_TOAST_DELETE=new o,c.S_IMAGE_REQUEST=new o,c.S_IMAGE_READY=new o,c.S_IMAGE_DOWNLOAD_REQUEST=new o,c.S_WS_MSG=new o,c.S_WS_SEND=new o,c.S_WS_AUTHORIZED=new o,c.S_WS_WRONG_AUTHORIZATION=new o,c.S_WS_CLOSED=new o,c.S_WS_MSG_SENT_VIA_HTTP=new o,c.S_ALERT_ERROR=new o,c.S_GUI_MESSAGES_RENDERED=new o,c.S_GUI_CLOSE_CHAT=new o,c.S_GUI_OPEN_CHAT=new o,c.S_GUI_CHAT_CLOSED=new o,c.S_GUI_CHAT_OPENED=new o,c.S_GUI_REPOSITION_CHAT=new o,c.S_SHARED_OBJECT_READY=new o,c.S_REQUEST_CALL=new o,c.S_CALL_PLACED=new o,c.S_CALL_LOCAL_MEDIA_READY=new o,c.S_CALL_INCOMING=new o,c.S_CALL_ACCEPT=new o,c.S_CALL_DECLINE=new o,c.S_CALL_ACCEPTED=new o,c.S_CALL_REMOTE_STREAM_READY=new o,c.S_CALL_CALLEE_ACCEPT_CALL=new o,c.S_LOG=new o,c.S_LOGE=new o,c.S_LOG_AVAIALABLE=new o,c.S_MEMBERS_READY=new o,c.S_MEMBERS_REQUEST=new o,c.S_DEPARTAMENTS_READY=new o,c.S_CHAT_STATUS_READ=new o,c.S_USER_IN_CHAT_STATUS_CHANGED=new o,c.S_CHAT_USER_STATUS_CHANGED=new o;t.a=c},13:function(e,t,a){"use strict";var n=a(3),r=a(4),i=function(){function e(){Object(n.a)(this,e)}return Object(r.a)(e,null,[{key:"scrollbar",get:function(){return"dark"===this.scheme?"#14171E":"blue"===this.scheme?"#060E37":"#E8F3FB"}},{key:"defaultColor",get:function(){return"#484654"}},{key:"lightTextColor",get:function(){return"rgba(0, 0, 0, 0.5)"}},{key:"lightBorderColor",get:function(){return"rgba(0, 0, 0, 0.2)"}},{key:"disabledColor",get:function(){return"#3e3e3e"}},{key:"chatBG",get:function(){return"dark"===this.scheme?"#14171E":"blue"===this.scheme?"#060E37":"#E8F3FB"}},{key:"chatColor",get:function(){return"dark"===this.scheme?"#222730":"blue"===this.scheme?"#1D2852":"#FFFFFF"}},{key:"chatTextColor",get:function(){return"light"===this.scheme?"#14171E":"#F7F9FA"}},{key:"chatMineTextColor",get:function(){return"#F7F9FA"}},{key:"chatInputColor",get:function(){return"light"===this.scheme?"#14171E":"#F7F9FA"}},{key:"chatMessageTextSize",get:function(){return"14px"}},{key:"chatMessagePadding",get:function(){return"12px 12px 12px 12px"}},{key:"chatMessageBorderRadius",get:function(){return"17px"}},{key:"chatMessageSmallBorderRadius",get:function(){return"5px"}},{key:"chatMessageBg",get:function(){return"dark"===this.scheme?"#222730":"blue"===this.scheme?"#1D2852":"#FFFFFF"}},{key:"chatMessageBotItemBg",get:function(){return"#2FAA77"}},{key:"chatMessageBgLeft",get:function(){return"#2FAA77"}},{key:"chatMessageColorLeft",get:function(){return"dark"===this.scheme?"rgba(255,255,255,.95)":"rgba(0,0,0,.8)"}},{key:"chatMessageColorRight",get:function(){return"rgba(255,255,255,1)"}},{key:"chatMessageFileItemBg",get:function(){return"#283582"}},{key:"chatMessageFileMsgBg",get:function(){return"#3f51b5"}},{key:"chatMessageAuthorColor",get:function(){return"light"===this.scheme?"rgba(0,0,0,.5)":"#aed086"}},{key:"chatMessageTimeColor",get:function(){return"light"===this.scheme?"rgba(0,0,0,.5)":"rgba(255,255,255,.6)"}},{key:"chatMessageBotMenuColor",get:function(){return"light"===this.scheme?"red":"#ff9800"}},{key:"chatSendBtnBg",get:function(){return this.scheme,"#A5201C"}},{key:"chatHeadColor",get:function(){return"light"===this.scheme?"#14171E":"#FFFFFF"}},{key:"linkColor",get:function(){return"#0b3d65"}},{key:"linkBGColor",get:function(){return"rgba(255,255,255,.7)"}},{key:"linkBGColorHover",get:function(){return"rgba(255,255,255,1)"}},{key:"linkColorRight",get:function(){return"dark"===this.scheme?"#03a9f4":"#0b3d65"}},{key:"linkBGColorRight",get:function(){return"dark"===this.scheme?"rgba(0,0,0,.8)":"rgba(255,255,255,1)"}},{key:"latestColor",get:function(){return"#FFFFFF"}},{key:"toastBGColor",get:function(){return this.scheme,"#283582"}},{key:"toastTextColor",get:function(){return this.scheme,"#fff"}},{key:"messageCloudTaleLeft",get:function(){return"\n    &:before {\n      border-bottom-right-radius: 40px;\n      border-left: 20px solid ".concat(e.chatMessageBg,';\n      left: -10px;\n      transform: rotate(20deg);\n      bottom: 5px;\n      content: "";\n      height: 15px;\n      position: absolute;\n    }\n    &::after {\n      background-color: ').concat(e.chatBG,';\n      border-bottom-right-radius: 14px;\n      left: 10px;\n      transform: translate(-40px, 1px);\n      width: 30px;\n      bottom: 10px;\n      content: "";\n      height: 30px;\n      position: absolute;\n    }\n    ')}},{key:"messageCloudTaleRight",get:function(){return"\n    &:before {\n      border-bottom-left-radius: 40px;\n      border-right: 20px solid ".concat(e.chatMessageBgLeft,';\n      right: -10px;\n      transform: rotate(-20deg);\n      bottom: 5px;\n      content: "";\n      height: 15px;\n      position: absolute;\n    }\n    &::after {\n      background-color: ').concat(e.chatBG,';\n      border-bottom-left-radius: 14px;\n      right: -50px;\n      transform: translate(-30px, -1px);\n      width: 20px;\n      bottom: 7px;\n      content: "";\n      height: 30px;\n      position: absolute;\n    }\n    ')}}]),e}();i.scheme="light",t.a=i},21:function(e,t,a){"use strict";a.r(t);var n=a(1),r=a.n(n),i=a(6),s=a(2),o=a(3),c=a(4),u=a(13),l=a(0),h=function(){function e(){Object(o.a)(this,e),this.profile=void 0,this.scheme=null,this.key="web",this.devID=void 0,this.sharedObject=void 0,this.phoneAuth=-1,this.init()}return Object(c.a)(e,[{key:"init",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.REQ_CONFIG_SCHEMES.invoke();case 2:this.scheme=e.sent.current,l.a.S_SHARED_OBJECT_READY.add((function(e){t.sharedObject=e})),l.a.S_LOGOUT.add((function(){t.removeLocalUser()})),l.a.S_REQUEST_AUTHENTICATE.add((function(){t.sharedObject&&t.sharedObject.messenger?t.checkLocalUser():t.sharedObject&&t.sharedObject.payerAuthToken?t.authAsPayer(t.sharedObject.payerAuthToken):t.sharedObject&&t.sharedObject.traderAuthToken?t.authAsTrader(t.sharedObject.traderAuthToken,t.sharedObject.branch):t.authAsGuest()})),l.a.S_AUTH_CHECK.add((function(e){e(null!=t.key&&t.key.length>10)})),l.a.S_AUTH_REQUEST.add(function(){var e=Object(s.a)(r.a.mark((function e(a){var n,i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("123"),n=null,!a.login.startsWith("!")&&"bloom"!==a.login){e.next=8;break}return e.next=5,l.a.REQ_HTTP.invoke({method:"auth.web",username:a.login,password:a.password,deviceName:"WebChat",devID:t.getDevID(),appVersion:4});case 5:n=e.sent,e.next=11;break;case 8:return e.next=10,l.a.REQ_HTTP.invoke({method:"auth.ldap",login:a.login,pass:a.password,deviceName:"WebChat",devID:t.getDevID(),appVersion:4,createUser:!0});case 10:n=e.sent;case 11:if(!n.error){e.next=16;break}return(i=n.errorMsg)||(i="Unknown error"),l.a.S_AUTH_ERROR.invoke(i),e.abrupt("return");case 16:a.remember&&localStorage.setItem("chat_user_"+t.scheme,JSON.stringify(n.data)),t.authorized(n.data);case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.S_AUTH_REQUEST_BY_PHONE.add(function(){var e=Object(s.a)(r.a.mark((function e(a){var n,i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.phoneAuth=parseInt(a.phone),e.next=3,l.a.REQ_HTTP.invoke({method:"auth.requestCode",phone:t.phoneAuth,devID:t.getDevID()});case 3:if(!(n=e.sent).error){e.next=9;break}return(i=n.errorMsg)||(i="Unknown error"),l.a.S_AUTH_ERROR.invoke(i),e.abrupt("return");case 9:l.a.S_AUTH_CODE_REQUESTED.invoke();case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.REQ_CURRENT_PROFILE.listener=function(e,a){a(t.profile)},l.a.S_AUTH_CHECK_CODE.add(function(){var e=Object(s.a)(r.a.mark((function e(a){var n,i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.REQ_HTTP.invoke({method:"auth.checkCode",code:a.code,devID:t.getDevID(),buildVer:"web_test_0.1",phone:t.phoneAuth,appVersion:"2",ver:1,deviceName:navigator.userAgent});case 2:if(!(n=e.sent).error){e.next=8;break}return(i=n.errorMsg)||(i="Unknown error"),l.a.S_AUTH_ERROR.invoke(i),e.abrupt("return");case 8:a.remember&&localStorage.setItem("chat_user_"+t.scheme,JSON.stringify(n.data)),n.data&&n.data.profile&&(n.data.profile.isMobileUser=!0),t.authorized(n.data);case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.S_SERVICE_READY.invoke("auth");case 12:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"removeLocalUser",value:function(){localStorage.removeItem("chat_user_"+this.scheme),this.profile=void 0,this.key="web"}},{key:"checkLocalUser",value:function(){var e=localStorage.getItem("chat_user_"+this.scheme);if(e){var t=null;try{t=JSON.parse(e)}catch(a){return void l.a.S_NEED_AUTHENTICATE.invoke()}this.authorized(t)}else l.a.S_NEED_AUTHENTICATE.invoke()}},{key:"getDevID",value:function(){return this.devID||(this.devID=localStorage.getItem("chat_devid_"+this.scheme),this.devID||(this.devID=btoa(1e4*Math.random()+ +(new Date).getTime()+navigator.userAgent).substr(0,64),localStorage.setItem("chat_devid_"+this.scheme,this.devID))),this.devID}},{key:"authAsTrader",value:function(){var e=Object(s.a)(r.a.mark((function e(t,a){var n,i,s,o,c;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return this.authAsGuest(),e.abrupt("return");case 3:return e.next=5,l.a.REQ_HTTP.invoke({method:"auth.fxtrader",token:("live"===a?"2":"3")+t,devID:this.getDevID(),deviceName:"WebChat",appVersion:3,sts:!0,deployedVersion:"widget-mobile.js"});case 5:if(!(i=e.sent).error){e.next=12;break}return l.a.S_AUTH_ERROR.invoke("Can't authorize as registered bank user"),l.a.S_LOGE.invoke(i.errorMsg),i.errorMsg&&(i.errorMsg.indexOf("::")>-1?(i.errorMsg=i.errorMsg.split("::")[1],o="validateToken:",(c=i.errorMsg.indexOf(o))>-1&&(i.errorMsg=i.errorMsg.substring(c+o.length))):i.errorMsg=null===(s=i.errorMsg)||void 0===s?void 0:s.substring(8),l.a.S_ALERT_ERROR.invoke(i.errorMsg)),this.authAsGuest(),e.abrupt("return");case 12:this.sharedObject&&(this.sharedObject.payerAuthToken=null),null===(n=this.sharedObject)||void 0===n||delete n.payerAuthToken,this.authorized(i.data);case 15:case"end":return e.stop()}}),e,this)})));return function(t,a){return e.apply(this,arguments)}}()},{key:"authAsPayer",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return this.authAsGuest(),e.abrupt("return");case 3:return e.next=5,l.a.REQ_HTTP.invoke({method:"auth.payer",token:t});case 5:if(!(n=e.sent).error){e.next=11;break}return l.a.S_AUTH_ERROR.invoke("Can't authorize as registered bank user"),l.a.S_LOGE.invoke(n.errorMsg),this.authAsGuest(),e.abrupt("return");case 11:this.sharedObject&&(this.sharedObject.payerAuthToken=null),null===(a=this.sharedObject)||void 0===a||delete a.payerAuthToken,this.authorized(n.data);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"authAsGuest",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,a,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(t=localStorage.getItem("chat_widget_guest_"+this.scheme))){e.next=8;break}a=null;try{a=JSON.parse(t)}catch(r){}if(null==a){e.next=8;break}return l.a.S_LOG.invoke("Guest authorized from cache"),this.authorized(a),e.abrupt("return");case 8:return e.next=10,l.a.REQ_HTTP.invoke({method:"auth.guest"});case 10:if(!(n=e.sent).error){e.next=15;break}return l.a.S_AUTH_ERROR.invoke("Can't authorize as guest"),l.a.S_LOG.invoke(n.errorMsg),e.abrupt("return");case 15:localStorage.setItem("chat_widget_guest_"+this.scheme,JSON.stringify(n.data)),this.authorized(n.data);case 17:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"authorized",value:function(e){this.key=e.authKey,this.profile=e.profile;var t={profile:this.profile,key:this.key};l.a.S_LOG.invoke(["Authorized as:",t]),l.a.S_AUTH_COMPLETE.invoke(t)}}]),e}(),d=a(7),f=function(){function e(){Object(o.a)(this,e),this.dccapi=new d.a,this.url="",this.authKey="web",this.dccapi.debug=!0,this.dccapi.log=function(e){return l.a.S_LOG.invoke(e)},this.init()}return Object(c.a)(e,[{key:"init",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:l.a.S_AUTH_COMPLETE.add(function(){var e=Object(s.a)(r.a.mark((function e(a){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.authKey=a.key;case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.REQ_HTTP.listener=function(){var e=Object(s.a)(r.a.mark((function e(a,n){var i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.url&&-1!==t.url.indexOf("http")){e.next=5;break}return e.next=3,l.a.REQ_CONFIG_SCHEMES.invoke();case 3:i=e.sent,t.url=i[i.current].api;case 5:t.dccapi.call({key:t.authKey,url:t.url,encrypt:!0,request:a},n);case 6:case"end":return e.stop()}}),e)})));return function(t,a){return e.apply(this,arguments)}}(),l.a.S_SERVICE_READY.invoke("http");case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}]),e}(),p=a(5),v=function(){function e(){var t=this;Object(o.a)(this,e),this.chat=void 0,this.sharedObject=null,this.authData=null,this.uploadingFiles=new Map,this.sendEntryPointStart=function(e){var a;t.chat&&l.a.S_WS_SEND.invoke({method:"entryPointStart",data:{chatUID:null===(a=t.chat)||void 0===a?void 0:a.uid,text:e,pid:t.chat.pointID}})},l.a.S_SHARED_OBJECT_READY.add((function(e){t.sharedObject=e})),l.a.S_AUTH_COMPLETE.add((function(e){t.authData=e})),l.a.S_WS_AUTHORIZED.add(Object(s.a)(r.a.mark((function e(){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.authData){e.next=2;break}return e.abrupt("return");case 2:if(!(null===(a=t.sharedObject)||void 0===a?void 0:a.messenger)){e.next=4;break}return e.abrupt("return");case 4:case"end":return e.stop()}}),e)})))),l.a.S_CHAT_OPENING.add((function(e){var a,n;t.chat&&l.a.S_WS_SEND.invoke({method:"chatUserExit",data:{chatUID:null===(n=t.chat)||void 0===n?void 0:n.uid}});t.chat=e,l.a.S_CHAT_OPENED.invoke(t.chat),e.pointID&&e.pointID>0&&(l.a.S_LOG.invoke("Start entry point: "+e.pointID),t.sendEntryPointStart("EP START")),l.a.S_WS_SEND.invoke({method:"chatUserEnter",data:{chatUID:null===(a=t.chat)||void 0===a?void 0:a.uid}})})),l.a.REQ_CURRENT_CHAT.listener=function(e,a){t.chat&&a(t.chat)},l.a.S_CHAT_MESSAGE_SEND_REQUEST.add(function(){var e=Object(s.a)(r.a.mark((function e(a){var n,i,s;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.chat){e.next=3;break}return l.a.S_ALERT_ERROR.invoke("Chat not loaded yet!"),e.abrupt("return");case 3:if(i=null,0!==(a=(a=(a=a.replace(/^[\s\n\t\r]/gm,"")).replace(/[\s\n\t\r]$/gm,"")).replace(/ {2,}/gm,"")).length){e.next=9;break}return e.abrupt("return");case 9:if(!(a.length>2e3)){e.next=12;break}return l.a.S_ALERT_ERROR.invoke("Message too big!"),e.abrupt("return");case 12:return e.next=14,l.a.REQ_SECURITY_KEY.invoke({chatUID:t.chat.uid});case 14:if(s=e.sent){e.next=17;break}return e.abrupt("return");case 17:i=p.a.pack(a,s),l.a.S_WS_SEND.invoke({method:"msgAdd",data:{chatUID:null===(n=t.chat)||void 0===n?void 0:n.uid,text:i}}),t.chat.pointID&&t.chat.pointID>0&&t.sendEntryPointStart(i);case 20:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.S_CHAT_BOT_COMMAND_SEND_REQUEST.add((function(e){var a;if(t.chat){var n=JSON.stringify({method:"botCommand",type:"chatSystem",title:e.title,action:e.action,actionData:e.actionData});n=p.a.systemSequence+n;var r="^"+e.botUID+"^"+p.a.pack(n,p.a.companySequence);l.a.S_WS_SEND.invoke({method:"msgAdd",data:{chatUID:null===(a=t.chat)||void 0===a?void 0:a.uid,text:r}})}})),l.a.S_CHAT_SCREENSHOT_SEND_REQUEST.add(Object(s.a)(r.a.mark((function e(){var a,n,i,s,o;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=document.createElement("canvas"),n=a.getContext("2d"),i=document.createElement("video"),t.chat){e.next=5;break}return e.abrupt("return");case 5:if(n){e.next=8;break}return l.a.S_ALERT_ERROR.invoke("Can't capture screenshot"),e.abrupt("return");case 8:return s=null,e.prev=9,e.next=12,navigator.mediaDevices.getDisplayMedia();case 12:o=e.sent,i.srcObject=o,n.drawImage(i,0,0,1920,1080),s=a.toDataURL("image/png"),o.getTracks().forEach((function(e){return e.stop()})),e.next=23;break;case 19:return e.prev=19,e.t0=e.catch(9),l.a.S_ALERT_ERROR.invoke("Can't capture screenshot:\n"+e.t0),e.abrupt("return");case 23:if(s){e.next=26;break}return l.a.S_ALERT_ERROR.invoke("Can't capture screenshot:\nUnknown error"),e.abrupt("return");case 26:l.a.REQ_IMAGE_UPLOAD_AS_B64.invoke({fileName:"Screenshot_"+ +new Date+".png",chatUID:t.chat.uid,b64:s});case 27:case"end":return e.stop()}}),e,null,[[9,19]])})))),l.a.S_CHAT_FILE_SEND_REQUEST.add((function(e){t.chat&&(t.getFilesByChatUID(e),t.fireFiles())})),l.a.S_IMAGE_REQUEST.add(function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n,i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.chatUID){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,l.a.REQ_CHAT.invoke({chatUID:t.chatUID});case 4:if(a=e.sent){e.next=7;break}return e.abrupt("return");case 7:if(n=a.securityKey){e.next=10;break}return e.abrupt("return");case 10:return e.next=12,l.a.REQ_IMAGE_GET.invoke({thumb:t.thumb,imageUID:t.uid,key:n});case 12:(i=e.sent)&&l.a.S_IMAGE_READY.invoke({uid:t.uid,b64:i,thumb:t.thumb});case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.S_SHARED_OBJECT_READY.add((function(e){t.sharedObject=e})),l.a.S_SERVICE_READY.invoke("chat")}return Object(c.a)(e,[{key:"fireFiles",value:function(){var e=Array.from(this.uploadingFiles.values());e.sort((function(e,t){return e.started>t.started?1:t.started>e.started?-1:0})),l.a.S_FILE_UPLOADING_LIST_UPDATED.invoke(e)}},{key:"onFileUploaded",value:function(e,t){var a=this,n=this.uploadingFiles.get(e);n&&(n.status=t?"fail":"finish",setTimeout((function(){console.log("Check timestatus");var e,t=Object(i.a)(a.uploadingFiles);try{for(t.s();!(e=t.n()).done;){var n=e.value;"start"!==n[1].status&&a.uploadingFiles.delete(n[1].tempUID)}}catch(r){t.e(r)}finally{t.f()}a.fireFiles()}),3e3),this.fireFiles())}},{key:"getFilesByChatUID",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.REQ_FILE_PREVIEW_GET_BY_UID.invoke(t).then((function(e){return e&&(a.uploadingFiles=e)}));case 2:this.uploadingFiles.forEach((function(e){return a.uploadFile(e.file,e.tempUID)}));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"uploadFile",value:function(){var e=Object(s.a)(r.a.mark((function e(t,a){var n,i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:if(this.chat){e.next=4;break}return e.abrupt("return");case 4:if(n=!1,!this.isImage(t)){e.next=17;break}if(!(t.size>31457280)){e.next=10;break}return l.a.S_ALERT_ERROR.invoke("Can't upload image:"+t.name+", size too big: "+(t.size/1024/1024).toFixed(2)+"mb"),this.onFileUploaded(a,!0),e.abrupt("return");case 10:return i=this.chat.securityKey,l.a.S_FILE_PREVIEW_DELETE_ALL.invoke(this.chat.uid),e.next=14,l.a.REQ_IMAGE_UPLOAD.invoke({file:t,chatUID:this.chat.uid,secKey:i});case 14:n=!e.sent,e.next=25;break;case 17:if(!(t.size>26214400)){e.next=21;break}return l.a.S_ALERT_ERROR.invoke("Can't upload file:"+t.name+", size too big"),this.onFileUploaded(a,!0),e.abrupt("return");case 21:return l.a.S_FILE_PREVIEW_DELETE_ALL.invoke(this.chat.uid),e.next=24,l.a.REQ_FILE_UPLOAD.invoke({file:t,chatUID:this.chat.uid});case 24:n=!e.sent;case 25:this.onFileUploaded(a,n);case 26:case"end":return e.stop()}}),e,this)})));return function(t,a){return e.apply(this,arguments)}}()},{key:"isImage",value:function(e){return console.log(e.type),-1===e.type.indexOf("/image")&&(-1!==e.type.indexOf("jpeg")||-1!==e.type.indexOf("jpg")||-1!==e.type.indexOf("png")||-1!==e.type.indexOf("gif"))}}]),e}(),_=function e(){var t=this;Object(o.a)(this,e),this.webrtc=[{url:"stun:stun01.sipphone.com"},{url:"stun:stun.ekiga.net"},{url:"stun:stun.fwdnet.net"},{url:"stun:stun.ideasip.com"},{url:"stun:stun.iptel.org"},{url:"stun:stun.rixtelecom.se"},{url:"stun:stun.schlund.de"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"},{url:"stun:stunserver.org"},{url:"stun:stun.softjoys.com"},{url:"stun:stun.voiparound.com"},{url:"stun:stun.voipbuster.com"},{url:"stun:stun.voipstunt.com"},{url:"stun:stun.voxgratia.org"},{url:"stun:stun.xten.com"}],this.schemes={live:{api:"https://dccapi.dukascopy.com/",files:"https://dccfilesapi.dukascopy.com/?method=files.get&",ws:"wss://ws.dukascopy.com/",sequence:".ap.iO.Oe.eT.tP.vHIqv.mI.xd.5WIJ"},pre:{api:"https://pre-dccapi-02.site.dukascopy.com/",files:"https://dccfilesapi.dukascopy.com/?method=files.get&",ws:"wss://ws1.dukascopy.com/",sequence:".ap.iO.Oe.eT.tP.vHIqv.mI.xd.5WIJ"},test:{api:"https://loki.telefision.com/master/",files:"https://loki.telefision.com/master/?method=files.get&",ws:"wss://loki.telefision.com/wss/",sequence:".ap.iO.Oe.eT.tP.vHIqv.mI.xd.5WIJ"},current:"live"},l.a.S_SHARED_OBJECT_READY.add((function(e){l.a.S_LOG.invoke("SETUP SCEHEMES"),!e.scheme||"live"!==e.scheme&&"test"!==e.scheme&&"pre"!==e.scheme||(t.schemes.current=e.scheme)})),l.a.REQ_CONFIG_SCHEMES.listener=function(e,a){a(t.schemes)},l.a.S_SERVICE_READY.invoke("config")};_.TOAST_ACTIVE_TIME=5e3;var E=_,g=function(){function e(){Object(o.a)(this,e),this.ws=null,this.key=null,this.profile=null,this.url=null,this.init()}return Object(c.a)(e,[{key:"init",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:l.a.S_AUTH_COMPLETE.add(function(){var e=Object(s.a)(r.a.mark((function e(a){var n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.REQ_CONFIG_SCHEMES.invoke();case 2:n=e.sent,t.url=n[n.current].ws,t.key=a.key,t.profile=a.profile,t.connect();case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.REQ_WS_STATUS.listener=function(e,a){a(t.ws?t.ws.readyState:3)},l.a.S_WS_SEND.add((function(e){if(!t.ws||t.ws.readyState!==WebSocket.OPEN)return"msgAdd"===e.method?void t.sendMsgViaPHP(e):void console.warn("Can't send packet, no active connection");if("pong"!==e.method){var a="WS >---------";a+="\n\t"+t.url,a+=t.generateDebug(e),a+="\nWS <---------",l.a.S_LOG.invoke(a)}t.ws.send(JSON.stringify(e))})),l.a.S_SERVICE_READY.invoke("ws");case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"sendMsgViaPHP",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n,i,s,o,c;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a={method:"api.wsSend",pushable:!0},null==t.data||"object"!==typeof t.data){e.next=5;break}for(n in t.data)a[n]=t.data[n];e.next=6;break;case 5:return e.abrupt("return");case 6:return e.next=8,l.a.REQ_HTTP.invoke(a);case 8:if(!(i=e.sent).error){e.next=13;break}return console.error("Can't send msg via HTTP, "+i.errorMsg),l.a.S_TOAST.invoke("Can't send message, try to refresh page"),e.abrupt("return");case 13:for(s=i.data,o=0;o<2;o++)"object"===typeof s&&"data"in s&&"object"===typeof s.data&&(s=s.data);if(!(s&&"error"in s&&s.error)){e.next=20;break}return console.error("Can't send msg via HTTP, WS ERR: "),l.a.S_TOAST.invoke("Can't send message, try to refresh page"),e.abrupt("return");case 20:if(!("msgData"in s)||"object"!==typeof s.msgData){e.next=29;break}return e.next=23,l.a.REQ_CURRENT_PROFILE.invoke();case 23:if(c=e.sent){e.next=26;break}return e.abrupt("return");case 26:return this.parsePacket(JSON.stringify({method:"msgAdd",data:{anonymous:!1,chatUID:t.data.chatUID,chat_uid:t.data.chatUID,created:Math.round(+new Date/1e3),delivery:"sent",id:s.msgData.id,mid:"",num:s.msgData.num,platform:"desktop",stat:[],status:"created",text:t.data.text,user_avatar:c.avatar,user_name:c.name,user_uid:c.uid}})),l.a.S_WS_MSG_SENT_VIA_HTTP.invoke({num:s.msgData.num,id:s.msgData.id,text:t.data.text,chatUID:t.data.chatUID}),e.abrupt("return");case 29:l.a.S_TOAST.invoke("Can't send message, try to refresh page");case 30:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"generateDebug",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a="",n="",r=0;r<t;r++)n+="\t";for(var i in e){var s=e[i];null===s||void 0===s?a+="\n"+n+i+": null":"object"===typeof s?a+="\n"+n+i+":"+this.generateDebug(s,++t):("string"===typeof s&&s.length>60&&(s=s.substr(0,50)+"... total("+s.length+")"),a+="\n"+n+i+": "+s)}return a}},{key:"connect",value:function(){var e=this;this.close(),null!=this.url&&null!=this.key&&(l.a.S_LOG.invoke("WS Connecting to: "+this.url),this.ws=new WebSocket(this.url),this.ws.onopen=function(t){var a;l.a.S_LOG.invoke("WS opened"),null!=e.key?"guest"===(null===(a=e.profile)||void 0===a?void 0:a.type)?l.a.S_WS_SEND.invoke({method:"auth",data:{authKey:e.key,guestName:e.profile.name,guestUID:e.profile.uid}}):l.a.S_WS_SEND.invoke({method:"auth",data:{authKey:e.key}}):e.close()},this.ws.onclose=function(t){l.a.S_WS_CLOSED.invoke(),l.a.S_LOG.invoke("WS closed"),setTimeout((function(){e.connect()}),3e3)},this.ws.onerror=function(e){l.a.S_LOGE.invoke(["WS error",e])},this.ws.onmessage=function(t){if("string"===typeof t.data){var a=t.data;a.startsWith('{"method":"ping",')?l.a.S_WS_SEND.invoke({method:"pong",data:null}):e.parsePacket(a)}})}},{key:"parsePacket",value:function(e){var t=null;try{t=JSON.parse(e)}catch(r){}if(null!==t)if("method"in t&&"data"in t){var a,n;if("auth"===t.method)return l.a.S_LOG.invoke("WS authorized on: "+this.url),void l.a.S_WS_AUTHORIZED.invoke(null===(a=this.profile)||void 0===a?void 0:a.type);if("init"!==t.method)l.a.S_WS_MSG.invoke(t);else t.data&&!t.data.error?l.a.S_WS_AUTHORIZED.invoke(null===(n=this.profile)||void 0===n?void 0:n.type):l.a.S_WS_WRONG_AUTHORIZATION.invoke()}else console.error("Wrong packet structure");else console.error("Wrong packet from server")}},{key:"close",value:function(){null!=this.ws&&(this.ws.onclose=null,this.ws.onerror=null,this.ws.onmessage=null,this.ws.onopen=null,this.ws.close()),this.ws=null}}]),e}(),m=function(){function e(){var t=this;Object(o.a)(this,e),this.authKey="web",this.sharedObject=void 0,l.a.S_AUTH_COMPLETE.add((function(e){t.authKey=e.key})),l.a.S_SHARED_OBJECT_READY.add((function(e){t.sharedObject=e})),this.imageGet=this.imageGet.bind(this),this.uploadImage=this.uploadImage.bind(this),this.doImageUpload=this.doImageUpload.bind(this),l.a.REQ_IMAGE_UPLOAD.listener=this.uploadImage,l.a.REQ_IMAGE_GET.listener=this.imageGet,l.a.S_SERVICE_READY.invoke("images"),l.a.S_IMAGE_DOWNLOAD_REQUEST.add((function(e){var a;"msg"===e.target&&(null===(a=t.sharedObject)||void 0===a?void 0:a.messenger)||t.onImageDownloadRequest(e)})),l.a.REQ_IMAGE_UPLOAD_AS_B64.listener=this.doImageUpload}return Object(c.a)(e,[{key:"onImageDownloadRequest",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.REQ_SECURITY_KEY.invoke({chatUID:t.chatUID});case 2:if(a=e.sent){e.next=5;break}return e.abrupt("return");case 5:this.imageGet({thumb:!1,imageUID:t.uid,key:a},(function(e){if(!e)return l.a.S_TOAST.invoke("Can't download image, try later"),void l.a.S_LOGE.invoke("Can't download image");var a=e,n=document.createElement("a");document.body.appendChild(n),n.href=a,n.target="_self",n.download=t.name,n.click(),n.remove()}));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"imageGet",value:function(){var e=Object(s.a)(r.a.mark((function e(t,a){var n,i,s;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new XMLHttpRequest,e.next=3,l.a.REQ_CONFIG_SCHEMES.invoke();case 3:if(i=e.sent,this.authKey){e.next=7;break}return l.a.S_LOGE.invoke("No auth key, can't load images"),e.abrupt("return");case 7:s=i[i.current].files+"uid="+t.imageUID+"&key="+this.authKey,t.thumb&&(s+="&thumb=1"),n.onload=function(e){var r=new Uint8Array(n.response),i=p.a.imagePacker.decrypt(r,t.key);null!=i?(i="data:image/jpeg;base64,"+btoa(i),a(i)):a(null)},n.responseType="arraybuffer",n.open("get",s,!0),n.send();case 13:case"end":return e.stop()}}),e,this)})));return function(t,a){return e.apply(this,arguments)}}()},{key:"uploadImage",value:function(){var e=Object(s.a)(r.a.mark((function e(t,a){var n,i=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(n=new FileReader).onload=function(){var e=Object(s.a)(r.a.mark((function e(s){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l.a.S_LOG.invoke("Image read, try to upload"),e.next=3,i.doImageUpload({fileName:t.file.name,b64:n.result,chatUID:t.chatUID},a);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),n.readAsDataURL(t.file);case 3:case"end":return e.stop()}}),e)})));return function(t,a){return e.apply(this,arguments)}}()},{key:"doImageUpload",value:function(){var e=Object(s.a)(r.a.mark((function e(t,a){var n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=document.createElement("img"),l.a.S_LOG.invoke("Image read, uploading 1"),n.onload=function(){var e=Object(s.a)(r.a.mark((function e(i){var s,o,c,u,h,d,f,v;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l.a.S_LOG.invoke("Image read, uploading 2"),e.next=3,l.a.REQ_SECURITY_KEY.invoke({chatUID:t.chatUID});case 3:if(s=e.sent){e.next=6;break}return e.abrupt("return");case 6:if(o=p.a.imagePacker.get2ImagesForSend(n,s)){e.next=11;break}return l.a.S_TOAST.invoke("Can't send image, "+t.fileName),a&&a(!1),e.abrupt("return");case 11:return c=t.fileName,e.next=14,l.a.REQ_HTTP.invoke({method:"files.addImage",chatUID:t.chatUID,image:o[0],thumb:o[1],title:c,crypted:"1",b64:"1"});case 14:if(!(u=e.sent).error&&null!=u.data){e.next=19;break}return l.a.S_ALERT_ERROR.invoke("Can't upload image: "+u.errorMsg),a&&a(!1),e.abrupt("return");case 19:h=u.data,d=h.name,f=h.uid,v=p.a.pack(p.a.systemSequence+JSON.stringify({method:"fileSended",title:d,type:"file",fileType:"cimg",additionalData:f+","+n.width+","+n.height}),s),l.a.S_WS_SEND.invoke({method:"msgAdd",data:{chatUID:t.chatUID,text:v}}),a&&a(!0);case 23:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),n.src=t.b64;case 4:case"end":return e.stop()}}),e)})));return function(t,a){return e.apply(this,arguments)}}()}]),e}(),S=a(11),k=a.n(S),C=function(){function e(){Object(o.a)(this,e),this.key=void 0,this.scheme=null,this.init()}return Object(c.a)(e,[{key:"init",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:l.a.S_AUTH_COMPLETE.add(function(){var e=Object(s.a)(r.a.mark((function e(a){var n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.REQ_CONFIG_SCHEMES.invoke();case 2:n=e.sent,t.scheme=n[n.current],t.key=a.key;case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.REQ_FILE_UPLOAD.listener=this.upload,l.a.S_FILE_DOWNLOAD_REQUEST.add((function(e){var a,n=(null===(a=t.scheme)||void 0===a?void 0:a.files)+"uid="+e.uid+"&key="+t.key,r=document.createElement("a");r.setAttribute("download",e.name),r.href=n,document.body.appendChild(r),r.click(),r.remove()})),l.a.S_SERVICE_READY.invoke("files");case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"upload",value:function(e,t){var a=new FileReader;a.onload=function(){var n=Object(s.a)(r.a.mark((function n(i){var s;return r.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a.onload=null,n.next=3,l.a.REQ_HTTP.invoke({method:"files.addDoc",chatUID:e.chatUID,file:a.result,title:e.file.name});case 3:if((s=n.sent)&&!s.error&&s.data){n.next=8;break}return l.a.S_TOAST.invoke("Can't send file, "+e.file.name),t&&t(!1),n.abrupt("return");case 8:l.a.S_WS_SEND.invoke({method:"msgAdd",data:{chatUID:e.chatUID,text:p.a.systemSequence+JSON.stringify({method:"fileSended",type:"file",title:e.file.name,fileType:"file",fileData:s.data,additionalData:s.data.uid})}}),t&&t(!0);case 10:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}(),a.readAsDataURL(e.file)}}]),e}(),b=function(){function e(){Object(o.a)(this,e),this.uploadingFiles=new Map,this.chatUID=null,this.init()}return Object(c.a)(e,[{key:"init",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:l.a.S_CHAT_OPENED.add((function(e){t.chatUID=e.uid})),l.a.REQ_FILE_PREVIEW_GET_BY_UID.listener=function(e,a){a(t.uploadingFiles.get(e))},l.a.S_FILE_PREVIEW_ATTACH.add((function(e){if(l.a.S_LOG.invoke(e),e&&t.chatUID){l.a.S_LOG.invoke(e);for(var a=0;a<e.length;a++){var n=btoa(1e4*Math.random()+"_"+ +new Date),r=e[a];if(r){var i={file:r,tempUID:n,chatUID:t.chatUID,status:"start",started:+new Date};if(t.uploadingFiles.get(t.chatUID)){var s;null===(s=t.uploadingFiles.get(t.chatUID))||void 0===s||s.set(n,i)}else{var o=new Map;o.set(n,i),t.uploadingFiles.set(t.chatUID,o)}}}}})),l.a.S_FILE_PREVIEW_DELETE.add((function(e){var a;t.chatUID&&(null===(a=t.uploadingFiles.get(t.chatUID))||void 0===a||a.delete(e))})),l.a.S_FILE_PREVIEW_DELETE_ALL.add((function(e){t.uploadingFiles.delete(e)})),l.a.S_SERVICE_READY.invoke("filePreviewManager");case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}]),e}(),y=function e(){var t=this;Object(o.a)(this,e),this.logs=!1,this.errors=!1,l.a.S_SHARED_OBJECT_READY.add((function(e){e.enableLog&&(t.logs=!0,t.errors=!0)})),l.a.S_LOG_AVAIALABLE.add((function(e){t.logs=e,t.errors=e})),l.a.S_LOG.add((function(e){t.logs&&(Array.isArray(e)?console.log.apply(t,e):console.log(e))})),l.a.S_LOGE.add((function(e){t.errors&&(Array.isArray(e)?console.error.apply(t,e):console.error(e))})),l.a.S_SERVICE_READY.invoke("logger")},D=function(){function e(){var t=this;Object(o.a)(this,e),this.chats=[],this.profile=void 0,this.hash=null,this.sharedObject=void 0,this.currentChat=null,this.saveLastReadTimeoutID=void 0,this.loadLocalData=!0,this.lastReadMsgNum=new Map,l.a.S_LOGOUT.add((function(){localStorage.removeItem("dcc_live_last_read"),localStorage.removeItem("dcc_live_latest_hash"),localStorage.removeItem("dcc_live_latest"),t.profile=void 0})),l.a.S_AUTH_COMPLETE.add(function(){var e=Object(s.a)(r.a.mark((function e(a){var n,i,s,o;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.profile=a.profile,!t.sharedObject||!t.sharedObject.messenger){e.next=3;break}return e.abrupt("return");case 3:return n="133",i="Type your message...",t.sharedObject&&t.sharedObject.entryPointId&&(n=t.sharedObject.entryPointId),t.sharedObject&&t.sharedObject.promptMessage&&(i=t.sharedObject.promptMessage),e.next=9,l.a.REQ_HTTP.invoke({method:"company.startChat",epID:n,guestUID:"guest"===a.profile.type?a.profile.uid:null});case 9:if(!(s=e.sent).error){e.next=13;break}return l.a.S_ALERT_ERROR.invoke("Can't open chat, \n"+s.errorMsg),e.abrupt("return");case 13:if(s.data){e.next=16;break}return l.a.S_ALERT_ERROR.invoke("Can't open chat, no chat found"),e.abrupt("return");case 16:(o=s.data).securityKey=p.a.companySequence,o.promptMessage=i,t.sharedObject&&t.sharedObject.title&&(o.title=t.sharedObject.title),t.chats.push(o),l.a.S_CHAT_OPEN_REQUEST.invoke({chatUID:o.uid});case 22:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.S_SHARED_OBJECT_READY.add((function(e){t.sharedObject=e})),l.a.S_LATEST_REQUEST.add((function(e){e.viaServer?t.loadChats():t.fireLatest()})),l.a.S_CHAT_OPENED.add((function(e){t.sharedObject&&!t.sharedObject.messenger||(t.currentChat=e,t.fireLatest())})),l.a.S_CHAT_OPEN_REQUEST.add((function(e){e.chatUID&&t.openChatByUID(e.chatUID),e.userUID&&t.openChatByUserUID(e.userUID)})),l.a.REQ_SECURITY_KEY.listener=function(){var e=Object(s.a)(r.a.mark((function e(a,n){var i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.sharedObject||t.sharedObject.messenger){e.next=3;break}return n(p.a.companySequence),e.abrupt("return");case 3:return e.next=5,t.getChatByUID(a.chatUID);case 5:if(i=e.sent){e.next=9;break}return n(null),e.abrupt("return");case 9:if("company"!==i.type){e.next=12;break}return n(p.a.companySequence),e.abrupt("return");case 12:n(i.securityKey);case 13:case"end":return e.stop()}}),e)})));return function(t,a){return e.apply(this,arguments)}}(),l.a.REQ_CHAT.listener=function(){var e=Object(s.a)(r.a.mark((function e(a,n){var i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.getChatByUID(a.chatUID);case 2:i=e.sent,n(i);case 4:case"end":return e.stop()}}),e)})));return function(t,a){return e.apply(this,arguments)}}(),l.a.S_SERVICE_READY.invoke("latest"),l.a.S_MESSAGE_ADDED.add(function(){var e=Object(s.a)(r.a.mark((function e(a){var n,i,s,o,c;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.sharedObject||t.sharedObject.messenger){e.next=2;break}return e.abrupt("return");case 2:if(a){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,t.getChatByUID(a.chatUID);case 6:if(o=e.sent){e.next=9;break}return e.abrupt("return");case 9:if(a.num!==(null===(n=o.message)||void 0===n?void 0:n.num)||a.text!==(null===(i=o.message)||void 0===i?void 0:i.text)){e.next=11;break}return e.abrupt("return");case 11:if(!(a.num<(null===(s=o.message)||void 0===s?void 0:s.num))){e.next=13;break}return e.abrupt("return");case 13:return o.message=a,t.setupChatTime(o),e.next=17,l.a.REQ_CURRENT_CHAT.invoke();case 17:if(!(c=e.sent)||c.uid!==a.chatUID){e.next=20;break}return e.abrupt("return");case 20:t.fireLatest();case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),l.a.S_MESSAGE_READ.add((function(e){t.sharedObject&&!t.sharedObject.messenger||(t.lastReadMsgNum.set(e.chatUID,e.num),console.log("MSG READ"),t.saveLastReadMsg(),t.fireLatest())})),l.a.S_WS_AUTHORIZED.add((function(){t.sharedObject&&t.sharedObject.messenger&&t.loadChats()}))}return Object(c.a)(e,[{key:"saveLastReadMsg",value:function(){var e=this;clearTimeout(this.saveLastReadTimeoutID),setTimeout((function(){var t,a=[],n=Object(i.a)(e.lastReadMsgNum);try{for(n.s();!(t=n.n()).done;){var r=t.value;r[0]&&a.push({uid:r[0],num:r[1]})}}catch(s){n.e(s)}finally{n.f()}localStorage.setItem("dcc_live_last_read",JSON.stringify(a))}),5e3)}},{key:"getChatByUID",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n,s,o,c;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=null,n=Object(i.a)(this.chats),e.prev=2,n.s();case 4:if((s=n.n()).done){e.next=11;break}if((o=s.value).uid!==t){e.next=9;break}return a=o,e.abrupt("break",11);case 9:e.next=4;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(2),n.e(e.t0);case 16:return e.prev=16,n.f(),e.finish(16);case 19:if(a){e.next=31;break}return e.next=22,l.a.REQ_HTTP.invoke({method:"chat.get",chatUID:t});case 22:if(!(c=e.sent).error){e.next=26;break}return console.log("Can't get chat "+c.errorMsg),e.abrupt("return",null);case 26:return e.next=28,this.addChat(c.data,!1,!1);case 28:a=e.sent,console.log(this.chats.length),this.saveLocalChats();case 31:return e.abrupt("return",a);case 32:case"end":return e.stop()}}),e,this,[[2,13,16,19]])})));return function(t){return e.apply(this,arguments)}}()},{key:"getChatByUserUID",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=null){e.next=13;break}return e.next=4,l.a.REQ_HTTP.invoke({method:"chat.start",usersUID:t});case 4:if(!(n=e.sent).error){e.next=8;break}return console.log("Can't get chat "+n.errorMsg),e.abrupt("return",null);case 8:return e.next=10,this.addChat(n.data,!1,!1);case 10:a=e.sent,console.log(this.chats.length),this.saveLocalChats();case 13:return e.abrupt("return",a);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"openChatByUID",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getChatByUID(t);case 2:if(a=e.sent){e.next=6;break}return l.a.S_ALERT_ERROR.invoke("Can't open chat, no chat found"),e.abrupt("return");case 6:l.a.S_CHAT_OPENING.invoke(a);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"openChatByUserUID",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getChatByUserUID(t);case 2:if(a=e.sent){e.next=6;break}return l.a.S_ALERT_ERROR.invoke("Can't open chat, no chat found"),e.abrupt("return");case 6:l.a.S_CHAT_OPENING.invoke(a);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"loadChats",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,a,n,s,o,c,u,h,d,f,p,v,_;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.loadLocalData){e.next=27;break}if(t=localStorage.getItem("dcc_live_last_read"))try{a=JSON.parse(t),n=Object(i.a)(a);try{for(n.s();!(s=n.n()).done;)(o=s.value).uid&&this.lastReadMsgNum.set(o.uid,o.num)}catch(E){n.e(E)}finally{n.f()}}catch(g){console.error("Can't setup last read msgs ",g)}if(!(c=localStorage.getItem("dcc_live_latest"))){e.next=25;break}try{u=JSON.parse(c)}catch(g){}if(!u){e.next=25;break}h=Object(i.a)(u),e.prev=8,h.s();case 10:if((d=h.n()).done){e.next=16;break}return f=d.value,e.next=14,this.addChat(f,!1);case 14:e.next=10;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(8),h.e(e.t0);case 21:return e.prev=21,h.f(),e.finish(21);case 24:this.fireLatest();case 25:this.hash=localStorage.getItem("dcc_live_latest_hash"),this.loadLocalData=!1;case 27:return e.next=29,l.a.REQ_HTTP.invoke({method:"chat.hLatest",hash:this.hash});case 29:if(!(p=e.sent).error){e.next=34;break}return l.a.S_LOGE.invoke("Can't get latest: "+p.errorMsg),l.a.S_TOAST.invoke("Can't update chats"),e.abrupt("return");case 34:if(p.data&&"hash"in p.data&&localStorage.setItem("dcc_live_latest_hash",p.data.hash),!(p.data&&"latest"in p.data&&Array.isArray(p.data.latest))){e.next=46;break}v=p.data.latest,e.t1=r.a.keys(v);case 38:if((e.t2=e.t1()).done){e.next=44;break}return _=e.t2.value,e.next=42,this.addChat(v[_],!1);case 42:e.next=38;break;case 44:this.saveLocalChats(),this.fireLatest();case 46:case"end":return e.stop()}}),e,this,[[8,18,21,24]])})));return function(){return e.apply(this,arguments)}}()},{key:"saveLocalChats",value:function(){localStorage.setItem("dcc_live_latest",JSON.stringify(this.chats))}},{key:"addChat",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n,i,s,o,c,u=arguments;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=!(u.length>1&&void 0!==u[1])||u[1],n=!(u.length>2&&void 0!==u[2])||u[2],e.next=4,this.prepareChat(t,n);case 4:i=e.sent,s=-1,o=this.chats.length,c=0;case 8:if(!(c<o)){e.next=15;break}if(this.chats[c].uid!==i.uid){e.next=12;break}return s=c,e.abrupt("break",15);case 12:c++,e.next=8;break;case 15:return s>-1?this.chats[s]=i:this.chats.push(i),this.chats.length>500&&this.chats.shift(),a&&this.fireLatest(),e.abrupt("return",i);case 19:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"prepareChat",value:function(){var e=Object(s.a)(r.a.mark((function e(t,a){var n,s,o,c,u,h;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.parsed){e.next=2;break}return e.abrupt("return",t);case 2:if("company"===t.securityKey&&(t.securityKey=p.a.companySequence),!(n=t.title).startsWith("!")){e.next=8;break}t.title=p.a.unpack(n.substr(1),t.securityKey),e.next=30;break;case 8:if(!t.users){e.next=30;break}n="",s=Object(i.a)(t.users),e.prev=11,s.s();case 13:if((o=s.n()).done){e.next=21;break}if((u=o.value).uid!==(null===(c=this.profile)||void 0===c?void 0:c.uid)){e.next=17;break}return e.abrupt("continue",19);case 17:""!==n&&(n+=", "),n+=u.name;case 19:e.next=13;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(11),s.e(e.t0);case 26:return e.prev=26,s.f(),e.finish(26);case 29:""!==n&&(t.title=n);case 30:if(!t.message||!a){e.next=35;break}return e.next=33,l.a.REQ_MESSAGE_PARSE_FROM_CHAT.invoke({chat:t});case 33:h=e.sent,t.message=h;case 35:return this.setupChatTime(t),t.parsed=!0,e.abrupt("return",t);case 38:case"end":return e.stop()}}),e,this,[[11,23,26,29]])})));return function(t,a){return e.apply(this,arguments)}}()},{key:"setupChatTime",value:function(e){var t,a,n,r=parseInt(e.created),i=e.message?parseInt(e.message.created):0;e.chatTime=i>r?i:r,e.chatTime=1e3*e.chatTime,e.date=p.a.dateFormatter.format(e.chatTime,"%d, %M, %y"),e.time=p.a.dateFormatter.format(e.chatTime,"%h:%i"),e.DOY=p.a.dateFormatter.getDayOfYear(e.chatTime),e.author=null===(t=e.message)||void 0===t?void 0:t.user_name,e.message&&e.message.user_uid===(null===(a=this.profile)||void 0===a?void 0:a.uid)&&(e.author="you"),"private"===e.type&&e.message&&e.message.user_uid!==(null===(n=this.profile)||void 0===n?void 0:n.uid)&&(e.author=null)}},{key:"fireLatest",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,a,n,s,o,c,u;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.chats.sort((function(e,t){return e.chatTime>t.chatTime?-1:t.chatTime>e.chatTime?1:0})),t=null,a=Object(i.a)(this.chats);try{for(a.s();!(n=a.n()).done;)(o=n.value).selected=!1,o.position="standalone",t&&o.DOY===t.DOY&&(o.position="middle"),t=o,this.currentChat&&o.uid===this.currentChat.uid&&(o.selected=!0),(!(c=this.lastReadMsgNum.get(o.uid))||c<1)&&(c=-1),o.unread=99,c>0&&o.message&&((u=o.message.num-c)>99&&(u=99),o.unread=u),o.message&&o.message.user_uid===(null===(s=this.profile)||void 0===s?void 0:s.uid)&&(o.unread=0),o.unread<0&&(o.unread=0)}catch(r){a.e(r)}finally{a.f()}l.a.S_LATEST_READY.invoke(this.chats);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),T=function(){function e(){var t=this;Object(o.a)(this,e),this.messages=new Map,this.lastUpdatedTime=new Map,this.messagesHash=new Map,this.lastUpdateTimerId=void 0,this.profile=void 0,this.currentOpenedChatUID=null,this.wsWatcherTimerID=void 0,l.a.S_AUTH_COMPLETE.add((function(e){t.profile=e.profile})),l.a.REQ_MESSAGE_PARSE_FROM_CHAT.listener=function(){var e=Object(s.a)(r.a.mark((function e(a,n){var i,s;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a.chat){e.next=2;break}return e.abrupt("return");case 2:if(i=a.chat.message){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,t.prepareMessage(i,a.chat);case 7:s=e.sent,n(s);case 9:case"end":return e.stop()}}),e)})));return function(t,a){return e.apply(this,arguments)}}(),l.a.S_WS_MSG.add((function(e){"msgAdd"!==e.method&&"msgChange"!==e.method&&"msgRemove"!==e.method||"msgAdd"===e.method&&t.addMsg(e.data)})),l.a.S_CHAT_OPENING.add((function(e){t.requestMessages(e.uid)})),l.a.S_CHAT_OPEN_REQUEST.add((function(e){e.chatUID&&l.a.S_CHAT_MESSAGES.invoke({chatUID:e.chatUID,msgs:[]})})),l.a.S_CHAT_OPENED.add((function(e){t.currentOpenedChatUID=e.uid,t.startWSWatcher()})),l.a.S_WS_MSG_SENT_VIA_HTTP.add((function(e){t.updateChatMessagesViaPHP(e.chatUID)})),l.a.S_SERVICE_READY.invoke("messages")}return Object(c.a)(e,[{key:"startWSWatcher",value:function(){var e=this;this.wsWatcherTimerID=setTimeout(Object(s.a)(r.a.mark((function t(){return r.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,l.a.REQ_WS_STATUS.invoke();case 2:t.sent>1&&null!=e.currentOpenedChatUID&&e.updateChatMessagesViaPHP(e.currentOpenedChatUID),e.startWSWatcher();case 5:case"end":return t.stop()}}),t)}))),3e4)}},{key:"updateChatMessagesViaPHP",value:function(e){var t=this,a=this.lastUpdatedTime.get(e);if(a||(a=0),+new Date-a<2e3)return this.lastUpdateTimerId&&clearTimeout(this.lastUpdateTimerId),void(this.lastUpdateTimerId=setTimeout((function(){t.updateChatMessagesViaPHP(e)}),3e3));this.requestMessages(e,0,15,!0)}},{key:"requestMessages",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n,i,s,o,c,u,h=arguments;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=h.length>1&&void 0!==h[1]?h[1]:0,n=h.length>2&&void 0!==h[2]?h[2]:100,i=h.length>3&&void 0!==h[3]&&h[3],this.lastUpdatedTime.set(t,+new Date),s=this.messages.get(t),o=this.messagesHash.get(t),i||s&&s.length>0&&this.broadcastMessages(t),e.next=9,l.a.REQ_HTTP.invoke({method:"chat.hGetMessages",chatUID:t,banan:a+"",limit:n,hash:o&&i?o:"-1"});case 9:if(!(c=e.sent).error){e.next=13;break}return i||l.a.S_ALERT_ERROR.invoke("Can't get messages, "+(null===(u=c.errorMsg)||void 0===u?void 0:u.substr(10))+"..."),e.abrupt("return");case 13:if(c.data&&"object"===typeof c.data){e.next=15;break}return e.abrupt("return");case 15:i&&this.messagesHash.set(t,c.data.hash),this.parseMessages(c.data.messages);case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"addMsg",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n,i,s,o,c=arguments;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=!(c.length>1&&void 0!==c[1])||c[1],e.next=3,this.prepareMessage(t,null);case 3:if(!((n=e.sent).sys&&"string"===typeof n.sys.additionalData&&n.sys.additionalData.toLowerCase().indexOf("ratebot")>-1)){e.next=6;break}return e.abrupt("return",null);case 6:(i=this.messages.get(n.chatUID))||(i=[],this.messages.set(n.chatUID,i)),s=!1,e.t0=r.a.keys(i);case 10:if((e.t1=e.t0()).done){e.next=19;break}if(o=e.t1.value,i[o].id!==n.id){e.next=17;break}return i[o]=n,s=!0,e.abrupt("break",19);case 17:e.next=10;break;case 19:return s||i.push(n),i.length>1e3&&i.shift(),a&&this.broadcastMessages(n.chatUID),l.a.S_MESSAGE_ADDED.invoke(n),e.abrupt("return",n);case 24:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"parseMessages",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n,i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Array.isArray(t)){e.next=10;break}e.t0=r.a.keys(t);case 2:if((e.t1=e.t0()).done){e.next=10;break}return n=e.t1.value,e.next=6,this.addMsg(t[n],!1);case 6:(i=e.sent)&&(a=i.chatUID),e.next=2;break;case 10:a&&Array.isArray(t)&&t.length>0&&this.broadcastMessages(a);case 11:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"broadcastMessages",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.REQ_CURRENT_CHAT.invoke();case 2:if(e.sent.uid===t){e.next=5;break}return e.abrupt("return");case 5:a=this.prepareMessagesList(t),l.a.S_CHAT_MESSAGES.invoke({chatUID:t,msgs:a}),a&&a.length>0&&l.a.S_MESSAGE_READ.invoke(a[a.length-1]);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"prepareMessagesList",value:function(e){var t=this.messages.get(e);if(!t||0===t.length)return[];t.sort((function(e,t){return e.num>t.num?1:t.num>e.num?-1:0}));for(var a=t.length,n=0;n<a;n++){var r=t[n];r.position="standalone",r.date=void 0;var i=null;if(n>0&&(i=t[n-1]),i){var s=p.a.dateFormatter.getDayOfYear(r.created),o=p.a.dateFormatter.getDayOfYear(i.created),c=r.created-i.created;r.user_uid===i.user_uid&&r.type===i.type&&s===o&&c<300?(r.position="middle","standalone"===i.position&&(i.position="first")):"standalone"!==i.position&&(i.position="last"),s!==o&&(r.date=p.a.dateFormatter.format(r.created,"%d, %M, %y"))}else r.date=p.a.dateFormatter.format(r.created,"%d, %M, %y")}var u=t[t.length-1];return"middle"===u.position&&(u.position="last"),t}},{key:"prepareMessage",value:function(){var e=Object(s.a)(r.a.mark((function e(t,a){var n,i,s,o;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.parsed){e.next=20;break}if(t.chat_uid&&(t.chatUID=t.chat_uid),t.chatUid&&(t.chatUID=t.chatUid),null!==a){e.next=7;break}return e.next=6,l.a.REQ_CHAT.invoke({chatUID:t.chatUID});case 6:a=e.sent;case 7:if(a){e.next=9;break}return e.abrupt("return",t);case 9:i=a.securityKey,t.text=p.a.unpack(t.text,i),t.id=parseInt(t.id+""),t.num=parseInt(t.num+""),t.version=parseInt(t.version+""),"guest"===a.ownerID&&t.user_name.startsWith("guest")?(t.mine=!0,t.side="right"):a.ownerID!==t.user_uid?(t.side="left",t.mine=!1):(t.side="right",t.mine=!0),"guest"!==(null===(n=this.profile)||void 0===n?void 0:n.type)&&((null===(s=this.profile)||void 0===s?void 0:s.uid)===t.user_uid?(t.side="right",t.mine=!0):(t.side="left",t.mine=!1)),t.mine||"company"!==a.type||(t.user_name="Dukascopy",t.user_avatar="dukascopy"),t.chat_uid&&(t.chatUID=t.chat_uid),t.chatUid&&(t.chatUID=t.chatUid),t.parsed=!0;case 20:if(t.type="text",t.text.startsWith(p.a.systemSequence)){t.type="system",o=null;try{o=JSON.parse(t.text.substr(p.a.systemSequence.length))}catch(r){l.a.S_LOGE.invoke(["Can't parse system message: "+t.text,r])}o&&(this.parseSystemMsg(o,t),t.sys=o)}return e.abrupt("return",t);case 23:case"end":return e.stop()}}),e,this)})));return function(t,a){return e.apply(this,arguments)}}()},{key:"parseSystemMsg",value:function(e,t){if("file"!==e.type||"cimg"!==e.fileType)if("file"!==e.type||"img"!==e.fileType)if("file"!==e.type){"method"in e&&(t.type="sys","vicomplete"===e.method.toLowerCase()&&(t.type="vi"),"vistart"===e.method.toLowerCase()&&(t.type="vi"),"vi_later"===e.method.toLowerCase()&&(t.type="vi"),"dukasnotesrequest"===e.method.toLowerCase()&&(t.type="dukanotes"),"vifail"===e.method.toLowerCase()&&(t.type="vi"),"credentials"===e.method&&"credentials"===e.type&&(t.type="credentials"),"voicesent"===e.method.toLowerCase()&&"voice"===e.type&&(t.type="voice"),"chatSystem"===e.type&&(t.type="chatSystem"),"chatSystem"===e.type&&"botMenu"===e.method&&(t.type="botMenu"),"chatSystem"===e.type&&"botCommand"===e.method&&(t.type="botCommand"));var a=t.text.substr(p.a.systemSequence.length);null!=e.title&&e.title.length>0&&a.length<1?a=e.title:(!a||a.length<1)&&(a="sys msg without title"),t.text=a}else t.type="file";else t.type="oldimg";else t.type="img"}}]),e}(),A=function e(){var t=this;Object(o.a)(this,e),this.profile=void 0,l.a.S_AUTH_COMPLETE.add((function(e){t.profile=e.profile})),l.a.S_SERVICE_READY.invoke("users")},R=function e(){var t=this;Object(o.a)(this,e),this.toasts=new Map,l.a.REQ_TOASTS.listener=function(e,a){a(Array.from(t.toasts.values()))},l.a.S_TOAST.add((function(e){if(t.toasts.size>=10){var a=t.toasts.entries().next().value[0];t.toasts.delete(a)}var n=btoa(1e4*Math.random()+"_"+ +new Date);t.toasts.set(n,{state:"active",text:e,created:+new Date,tempUID:n}),setTimeout((function(){l.a.S_TOAST_DELETE.invoke(n)}),E.TOAST_ACTIVE_TIME)})),l.a.S_TOAST_DELETE.add((function(e){t.toasts.delete(e)})),l.a.S_SERVICE_READY.invoke("toastManager")},O=function(){function e(){var t=this;Object(o.a)(this,e),this.members=[],this.departaments=new Map,l.a.S_AUTH_COMPLETE.add(Object(s.a)(r.a.mark((function e(){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.fireMembers();case 1:case"end":return e.stop()}}),e)})))),l.a.S_MEMBERS_REQUEST.add((function(e){l.a.S_MEMBERS_READY.invoke(t.members),l.a.S_DEPARTAMENTS_READY.invoke(t.departaments)})),l.a.S_WS_AUTHORIZED.add((function(){l.a.S_WS_SEND.invoke({method:"getCompanyOnlineUsers",data:null})})),l.a.S_SERVICE_READY.invoke("memebersManager")}return Object(c.a)(e,[{key:"fireMembers",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,a=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.REQ_HTTP.invoke({method:"company.get"});case 2:(t=e.sent).data&&(this.members=t.data.m,t.data.dep.map((function(e){return a.departaments.set(e.id,e)})),l.a.S_MEMBERS_READY.invoke(this.members),l.a.S_DEPARTAMENTS_READY.invoke(this.departaments));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),I=function e(){var t=this;Object(o.a)(this,e),this.currentChatUID=null,this.chatUsers=new Map,this.chatReadByUser=new Map,this.chatLastMsgID=new Map,l.a.S_CHAT_OPENING.add((function(e){t.currentChatUID=e.uid,t.chatUsers.set(t.currentChatUID,e.users.map((function(e){return e.uid}))),t.chatLastMsgID.set(t.currentChatUID,e.message.id)})),l.a.S_WS_MSG.add((function(e){var a,n,r,i,s,o,c,u,h,d;if("msgAdd"===e.method||"msgChange"===e.method||"msgRemove"===e.method)return e.data&&l.a.S_CHAT_STATUS_READ.invoke({chatUID:null===(a=e.data)||void 0===a?void 0:a.chatUID,userUID:null===(n=e.data)||void 0===n?void 0:n.user_uid,lastReadMsgID:null===(r=e.data)||void 0===r?void 0:r.id}),t.chatLastMsgID.set(null===(i=e.data)||void 0===i?void 0:i.chatUID,null===(s=e.data)||void 0===s?void 0:s.id),void l.a.REQ_USERS_IN_CHAT.invoke({chatUID:null===(o=e.data)||void 0===o?void 0:o.chatUID}).then((function(t){null===t||void 0===t||t.forEach((function(t,a){var n,r;t.active&&l.a.S_CHAT_STATUS_READ.invoke({chatUID:null===(n=e.data)||void 0===n?void 0:n.chatUID,userUID:a,lastReadMsgID:null===(r=e.data)||void 0===r?void 0:r.id})}))}));"chatUserEnter"===e.method&&(e.data&&(null===(c=e.data)||void 0===c||c.stat.map((function(t){var a;return l.a.S_CHAT_STATUS_READ.invoke({chatUID:null===(a=e.data)||void 0===a?void 0:a.chatUID,userUID:t.uid,lastReadMsgID:t.lastID||0})}))),l.a.S_CHAT_STATUS_READ.invoke({chatUID:null===(u=e.data)||void 0===u?void 0:u.chatUID,userUID:null===(h=e.data)||void 0===h?void 0:h.userUid,lastReadMsgID:t.chatLastMsgID.get(null===(d=e.data)||void 0===d?void 0:d.chatUID)||0}))})),l.a.REQ_LAST_READ_MSG.listener=function(e,a){a(t.chatReadByUser.get(e.chatUID))},l.a.S_CHAT_STATUS_READ.add((function(e){var a;t.chatReadByUser.get(null===e||void 0===e?void 0:e.chatUID)?null===(a=t.chatReadByUser.get(null===e||void 0===e?void 0:e.chatUID))||void 0===a||a.set(e.userUID,{lastReadMsgID:e.lastReadMsgID}):t.chatReadByUser.set(null===e||void 0===e?void 0:e.chatUID,(new Map).set(e.userUID,{lastReadMsgNum:e.lastReadMsgID}))})),l.a.S_SERVICE_READY.invoke("chatStatusManager")},w=function e(){var t=this;Object(o.a)(this,e),this.usersInChat=new Map,this.usersOnline=new Map,l.a.S_WS_MSG.add((function(e){var a,n,r,i;"chatUserEnter"===e.method&&e.data&&(l.a.S_USER_IN_CHAT_STATUS_CHANGED.invoke({chatUID:null===(a=e.data)||void 0===a?void 0:a.chatUID,userUID:null===(n=e.data)||void 0===n?void 0:n.userUid,active:!0}),t.usersInChat.forEach((function(t,a){var n;l.a.S_USER_IN_CHAT_STATUS_CHANGED.invoke({chatUID:a,userUID:null===(n=e.data)||void 0===n?void 0:n.userUid,active:!1})})),e.data.users.map((function(e){return l.a.S_CHAT_USER_STATUS_CHANGED.invoke({userUID:e.uid,online:!0})})));"chatUserExit"===e.method&&e.data&&l.a.S_USER_IN_CHAT_STATUS_CHANGED.invoke({chatUID:null===(r=e.data)||void 0===r?void 0:r.chatUID,userUID:null===(i=e.data)||void 0===i?void 0:i.userUid,active:!1});if("userStatus"===e.method&&e.data){var s="offline"!==e.data.status;l.a.S_CHAT_USER_STATUS_CHANGED.invoke({userUID:e.data.uid,online:s})}})),l.a.REQ_USERS_IN_CHAT.listener=function(e,a){a(t.usersInChat.get(e.chatUID))},l.a.REQ_USERS_STATUS.listener=function(e,a){a(t.usersOnline)},l.a.S_USER_IN_CHAT_STATUS_CHANGED.add((function(e){var a;t.usersInChat.get(null===e||void 0===e?void 0:e.chatUID)?null===(a=t.usersInChat.get(null===e||void 0===e?void 0:e.chatUID))||void 0===a||a.set(e.userUID,{active:e.active}):t.usersInChat.set(null===e||void 0===e?void 0:e.chatUID,(new Map).set(e.userUID,{active:e.active}))})),l.a.S_CHAT_USER_STATUS_CHANGED.add((function(e){t.usersOnline.set(null===e||void 0===e?void 0:e.userUID,{online:e.online})})),l.a.S_SERVICE_READY.invoke("chatUsersStatusManager")},U=function(){function e(){var t=this;Object(o.a)(this,e),this.profile=void 0,this.so=void 0,l.a.S_SHARED_OBJECT_READY.add((function(e){t.so=e})),l.a.S_AUTH_COMPLETE.add((function(e){t.profile=e.profile,t.so&&t.so.messenger&&t.profile&&(console.log(t.profile),t.getCompany())})),l.a.S_SERVICE_READY.invoke("company")}return Object(c.a)(e,[{key:"getCompany",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.a.REQ_HTTP.invoke({method:"company.get"});case 2:if((t=e.sent)&&!t.error){e.next=6;break}return console.error("Can't get company, "+t.errorMsg),e.abrupt("return");case 6:console.log(t);case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}]),e}(),x=function(){function e(){var t=this;Object(o.a)(this,e),this.profile=void 0,this.activeCall=void 0,this.peerConnection=void 0,this.webRTCConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stunserver.org"}]},l.a.S_AUTH_COMPLETE.add((function(e){t.profile=e.profile})),l.a.S_LOGOUT.add((function(){t.finishCall()})),l.a.S_WS_MSG.add((function(e){"blackHole"===e.method&&t.profile&&-1!==e.data.data.method.indexOf("call_")&&e.data.sender!==t.profile.uid&&t.onWSPacket(e.data.data.method,e.data.data.data)})),l.a.S_CALL_ACCEPT.add((function(e){t.callAccepted(e)})),l.a.S_REQUEST_CALL.add((function(e){if(e.chatVO){if(!Array.isArray(e.chatVO.users))return console.error("No user to call"),void l.a.S_ALERT_ERROR.invoke("NO USER TO CALL");if(!t.profile)return;var a,n=[{name:t.profile.name,uid:t.profile.uid,avatar:t.profile.avatar}],r=Object(i.a)(e.chatVO.users);try{for(r.s();!(a=r.n()).done;){var s=a.value;n.push({name:s.name,uid:s.uid,avatar:s.avatar})}}catch(o){r.e(o)}finally{r.f()}if(n.length<2||n.length>10)return console.error("Call avaiable only for 2 to 10 persons"),void l.a.S_ALERT_ERROR.invoke("Call avaiable only for 2 to 10 persons");t.startCalling(n,e.audio,e.video)}})),l.a.S_SERVICE_READY.invoke("call")}return Object(c.a)(e,[{key:"startCalling",value:function(){var e=Object(s.a)(r.a.mark((function e(t,a,n){var i;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.activeCall&&this.finishCall(),this.profile&&this.profile.uid){e.next=3;break}return e.abrupt("return");case 3:i=btoa(+new Date+"_"+1e4*Math.random()+"_"+this.profile.uid),this.activeCall={participians:t,audio:a,video:n,callID:i,side:"caller",localStream:null,remoteStream:null},this.sendCall(),l.a.S_CALL_PLACED.invoke(this.activeCall);case 7:case"end":return e.stop()}}),e,this)})));return function(t,a,n){return e.apply(this,arguments)}}()},{key:"sendCall",value:function(){var e,t,a;this.activeCall&&this.send("call_place",{callee:{uid:null===(e=this.profile)||void 0===e?void 0:e.uid,avatar:null===(t=this.profile)||void 0===t?void 0:t.avatar,name:null===(a=this.profile)||void 0===a?void 0:a.name},call:{callID:this.activeCall.callID,audio:this.activeCall.audio,video:this.activeCall.video,participians:this.activeCall.participians}})}},{key:"callAccepted",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.activeCall&&this.finishCall(),this.profile){e.next=3;break}return e.abrupt("return");case 3:return this.activeCall={callID:t.call.callID,audio:!0,video:!0,participians:t.call.participians,side:"callee",localStream:null,remoteStream:null},l.a.S_CALL_ACCEPTED.invoke(this.activeCall),e.next=7,this.createConnection();case 7:this.send("call_accepted",{callID:this.activeCall.callID,acceptor:null===(a=this.profile)||void 0===a?void 0:a.uid});case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"callAcceptedByCallee",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.profile){e.next=2;break}return e.abrupt("return");case 2:if(this.activeCall&&this.activeCall.callID===t.callID){e.next=4;break}return e.abrupt("return");case 4:return console.log("Call accepted by callee, make peer on caller side ",this.activeCall.side,t),e.next=7,this.createConnection();case 7:if(this.peerConnection){e.next=10;break}return console.error("NO PEER CONN"),e.abrupt("return");case 10:return e.prev=10,e.next=13,this.peerConnection.createOffer({offerToReceiveAudio:this.activeCall.audio,offerToReceiveVideo:this.activeCall.video});case 13:return a=e.sent,e.next=16,this.peerConnection.setLocalDescription(a);case 16:this.sendOffer(a),e.next=22;break;case 19:e.prev=19,e.t0=e.catch(10),console.error("Can't create offer!");case 22:l.a.S_CALL_CALLEE_ACCEPT_CALL.invoke(this.activeCall);case 23:case"end":return e.stop()}}),e,this,[[10,19]])})));return function(t){return e.apply(this,arguments)}}()},{key:"sendOffer",value:function(e){this.profile&&this.activeCall&&this.send("call_offer",{offer:e.toJSON(),userUID:this.profile.uid,callID:this.activeCall.callID})}},{key:"gotOffer",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a,n,i,s,o,c,u,l;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("GOT OFFER SIDE: "+(null===(a=this.activeCall)||void 0===a?void 0:a.side)),e.next=3,null===(n=this.peerConnection)||void 0===n?void 0:n.setRemoteDescription(t.offer);case 3:return e.next=5,null===(i=this.peerConnection)||void 0===i?void 0:i.createAnswer({offerToReceiveAudio:null===(s=this.activeCall)||void 0===s?void 0:s.audio,offerToReceiveVideo:null===(o=this.activeCall)||void 0===o?void 0:o.video});case 5:return l=e.sent,e.next=8,null===(c=this.peerConnection)||void 0===c?void 0:c.setLocalDescription(l);case 8:this.send("call_answer",{answer:l,userUID:null===(u=this.profile)||void 0===u?void 0:u.uid,callID:t.callID});case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"gotAnswer",value:function(){var e=Object(s.a)(r.a.mark((function e(t){var a;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,null===(a=this.peerConnection)||void 0===a?void 0:a.setRemoteDescription(t.answer);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),console.error("Can't set answer: ",e.t0);case 8:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"gotCandidate",value:function(){var e=Object(s.a)(r.a.mark((function e(t){return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:if(this.peerConnection){e.next=4;break}return e.abrupt("return");case 4:return e.prev=4,e.next=7,this.peerConnection.addIceCandidate(t);case 7:console.log("CAND ADDED"),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(4),console.error("Can't add candidate: ",t);case 13:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t){return e.apply(this,arguments)}}()},{key:"createConnection",value:function(){var e=Object(s.a)(r.a.mark((function e(t,a){var n=this;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.activeCall){e.next=2;break}return e.abrupt("return");case 2:if(this.peerConnection=new RTCPeerConnection(this.webRTCConfig),this.peerConnection.onicecandidate=function(e){var t;console.log("ICE CANDIDATE: ",e),n.send("call_ice_candidate",null===(t=e.candidate)||void 0===t?void 0:t.toJSON())},this.peerConnection.onconnectionstatechange=function(e){console.log("CONN STATE CHAGED: ",e)},this.peerConnection.onicegatheringstatechange=function(e){console.log("ICE GATHERING CHANGE: ",e)},this.peerConnection.onicecandidateerror=function(e){console.log("ICE CANDIDATE ERROR: ",e)},this.peerConnection.ontrack=function(e){n.activeCall&&(n.activeCall.remoteStream||(n.activeCall.remoteStream=new MediaStream),n.activeCall.remoteStream.addTrack(e.track),l.a.S_CALL_REMOTE_STREAM_READY.invoke(n.activeCall))},this.activeCall.localStream){e.next=11;break}return e.next=11,this.createLocalStream();case 11:if(this.activeCall.localStream){e.next=13;break}return e.abrupt("return");case 13:this.activeCall.localStream.getTracks().forEach((function(e){var t;return null===(t=n.peerConnection)||void 0===t?void 0:t.addTrack(e)}));case 14:case"end":return e.stop()}}),e,this)})));return function(t,a){return e.apply(this,arguments)}}()},{key:"createLocalStream",value:function(){var e=Object(s.a)(r.a.mark((function e(){var t,a,n;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=null,e.prev=1,e.next=4,navigator.mediaDevices.getUserMedia({audio:null===(a=this.activeCall)||void 0===a?void 0:a.audio,video:null===(n=this.activeCall)||void 0===n?void 0:n.video});case 4:t=e.sent,e.next=12;break;case 7:return e.prev=7,e.t0=e.catch(1),console.error("Can't get media: "+e.t0),l.a.S_ALERT_ERROR.invoke("Can't get media: "+e.t0),e.abrupt("return");case 12:t||(console.error("Can't place call, no media found"),l.a.S_ALERT_ERROR.invoke("Can't place call, no media found")),this.activeCall&&(this.activeCall.localStream=t,l.a.S_CALL_LOCAL_MEDIA_READY.invoke(this.activeCall));case 14:case"end":return e.stop()}}),e,this,[[1,7]])})));return function(){return e.apply(this,arguments)}}()},{key:"finishCall",value:function(){}},{key:"send",value:function(e,t){var a;if(this.activeCall&&this.profile){var n,r=[],s=Object(i.a)(null===(a=this.activeCall)||void 0===a?void 0:a.participians);try{for(s.s();!(n=s.n()).done;){var o=n.value;o.uid!==this.profile.uid&&r.push(o.uid)}}catch(c){s.e(c)}finally{s.f()}l.a.S_WS_SEND.invoke({method:"blackHole",data:{mode:"user",userUIDs:r,data:{method:e,data:t}}})}}},{key:"onWSPacket",value:function(e,t){"call_place"!==e?("call_offer"===e&&this.gotOffer(t),"call_answer"===e&&this.gotAnswer(t),"call_accepted"===e&&this.callAcceptedByCallee(t),"call_ice_candidate"!==e||this.gotCandidate(t)):l.a.S_CALL_INCOMING.invoke(t)}}]),e}(),L=a(8),M=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,null,[{key:"main",value:function(){var e=this,t=[y,E,m,C,b,g,f,h,T,v,x,D,U,R,A,O,I,w],a=0;for(var n in l.a.S_SERVICE_READY.add((function(n){a++,l.a.S_LOG.invoke("DCC -> Service initialized: "+n),a===t.length&&e.checkSharedObject()})),t)new t[n]}},{key:"checkSharedObject",value:function(){var t=Object(s.a)(r.a.mark((function t(){var a,n,s,o,c,h,d,f,v,_,E,g,m=this;return r.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((a=window).__DCCSharedObject){t.next=4;break}return setTimeout((function(){return m.checkSharedObject}),100),t.abrupt("return");case 4:if("object"==typeof(n=a.__DCCSharedObject)){t.next=8;break}return l.a.S_LOGE.invoke("Dukascopy Connect -> Wrong shared object"),t.abrupt("return");case 8:if(n.placeHolderID){t.next=11;break}return l.a.S_LOGE.invoke("Dukascopy Connect -> No placeholder id"),t.abrupt("return");case 11:if(!((s=document.location.href.split("?")).length>1)){t.next=45;break}o=s[1].split("&"),c={role:"payer",branch:"live",token:null,scheme:null,colors:null,mode:null,headless:!1,ep:-1},h=Object(i.a)(o),t.prev=16,h.s();case 18:if((d=h.n()).done){t.next=30;break}if(f=d.value){t.next=22;break}return t.abrupt("continue",28);case 22:v=f.split("="),_=v[0],E=v[1],_&&(_=_.replace(/^\s*|\s*$/gi,"").toLowerCase()),E&&(E=E.replace(/^\s*|\s*$/gi,"")),_ in c&&(c[_]=E);case 28:t.next=18;break;case 30:t.next=35;break;case 32:t.prev=32,t.t0=t.catch(16),h.e(t.t0);case 35:return t.prev=35,h.f(),t.finish(35);case 38:console.log(">>>> "+c),null!=c.token&&("payer"===c.role&&c.token&&(n.supportChatPayToken=c.token),"trader"===c.role&&c.token&&(n.supportChatTraderToken=c.token),null!=c.branch&&"trader"===c.role&&(c.branch=c.branch.toLowerCase(),"live"!==c.branch&&"demo"!==c.branch||(n.branch=c.branch))),c.headless&&(n.headless="1"===c.headless||"true"===c.headless.toLowerCase()),c.mode&&(c.mode=c.mode.toLowerCase(),"messenger"===c.mode&&(n.messenger=!0),"mobile"===c.mode&&(n.mobile=!0),"widget"===c.mode&&(n.mobile=!1,n.messenger=!1)),c.ep>-1&&(n.supportChatEp=c.ep),null!==c.colors&&(n.colors=c.colors),c.scheme&&(c.scheme=c.scheme.toLowerCase(),"live"!==c.scheme&&"test"!==c.scheme&&"pre"!==c.scheme||(n.scheme=c.scheme));case 45:if(g=document.getElementById(n.placeHolderID)){t.next=49;break}return l.a.S_LOGE.invoke("Dukascopy Connect -> No placeholder with id: "+n.placeHolderID),t.abrupt("return");case 49:return"supportChatEp"in n&&(n.entryPointId=n.supportChatEp),"supportChatPayToken"in n&&(n.payerAuthToken=n.supportChatPayToken),"supportChatTraderToken"in n&&(n.traderAuthToken=n.supportChatTraderToken),"supportChatTitle"in n&&(n.title=n.supportChatTitle),l.a.S_SHARED_OBJECT_READY.invoke(n),n.colors&&(u.a.scheme=n.colors),l.a.S_LOG.invoke(n),t.next=58,this.run(n,g);case 58:a.DCC_GD=l.a,a.DCC_Services=p.a,a.DCC_openChat=function(){l.a.S_GUI_OPEN_CHAT.invoke()},a.DCC_closeChat=function(){l.a.S_GUI_CLOSE_CHAT.invoke(null)},l.a.S_GUI_CHAT_OPENED.add((function(e){a.onDCC_ChatOpened&&"function"===typeof a.onDCC_ChatOpened&&0===a.onDCC_ChatOpened.length&&a.onDCC_ChatOpened()})),l.a.S_GUI_CHAT_CLOSED.add((function(e){a.onDCC_ChatClosed&&"function"===typeof a.onDCC_ChatClosed&&0===a.onDCC_ChatClosed.length&&a.onDCC_ChatClosed()})),a.__DCC_ver=function(){console.log("Dukascopy Connect HTML Widget, version ".concat(e.version," @ ","18.05.2022, 13:27:29"))},a.__DCC_help=function(){console.log("\n        Dukascopy Connect\n        available callback, registering in global scope:\n\n        onDCC_ChatLoaded() - invokes when Dukascopy Connect Chat Widget ready to work.\n        onDCC_ChatOpend() - invokes when Dukascopy Connect Chat Widget opened.\n        onDCC_ChatClosed() - invokes when Dukascopy Connect Chat Widget closed.\n\n        available methods:\n        DCC_openChat() - will open chat window\n        DCC_closeChat() - will close chat window\n        DCC_changeLanguage() - will change language (ISO 639-1)\n\n      ")},a.onDCC_ChatLoaded&&"function"===typeof a.onDCC_ChatLoaded&&0===a.onDCC_ChatLoaded.length&&a.onDCC_ChatLoaded(),l.a.S_APP_READY.invoke(),l.a.S_REQUEST_AUTHENTICATE.invoke();case 69:case"end":return t.stop()}}),t,this,[[16,32,35,38]])})));return function(){return t.apply(this,arguments)}}()},{key:"run",value:function(){var e=Object(s.a)(r.a.mark((function e(t,n){var i,s,o,c;return r.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.messenger){e.next=8;break}return e.next=3,Promise.all([a.e(0),a.e(1),a.e(5)]).then(a.bind(null,43));case 3:i=e.sent,s=i.default,k.a.render(Object(L.jsx)(s,{sharedObject:t}),n),e.next=13;break;case 8:return e.next=10,Promise.all([a.e(0),a.e(1)]).then(a.bind(null,40));case 10:o=e.sent,c=o.default,k.a.render(Object(L.jsx)(c,{sharedObject:t}),n);case 13:case"end":return e.stop()}}),e)})));return function(t,a){return e.apply(this,arguments)}}()}]),e}();M.version="3.0.8",M.main()},5:function(e,t,a){"use strict";a.d(t,"a",(function(){return c}));var n=a(3),r=a(4),i=function(){function e(){Object(n.a)(this,e)}return Object(r.a)(e,[{key:"format",value:function(e,t){var a=this.getDate(e);if(null==a)return"unknown date";var n=this.leadZero(a.getHours()),r=this.leadZero(a.getMinutes()),i=this.leadZero(a.getSeconds()),s=this.leadZero(a.getFullYear()),o=this.leadZero(a.getDate()),c=this.leadZero(a.getMonth()+1),u=a.toLocaleDateString("en-EN",{weekday:"long"}),l=a.toLocaleDateString("en-EN",{month:"long"});return t.replace(/%y/g,s).replace(/%m/g,c).replace(/%d/g,o).replace(/%h/g,n).replace(/%i/g,r).replace(/%s/g,i).replace(/%w/g,u).replace(/%M/g,l)}},{key:"dateOrTime",value:function(e){var t=this.getDate(e),a=new Date;return a.getDate()!==t.getDate()&&a.getMonth()!==t.getMonth()&&a.getFullYear()!==t.getFullYear()?this.leadZero(t.getDate())+"."+this.leadZero(t.getMonth())+"."+t.getFullYear():this.leadZero(t.getHours())+":"+this.leadZero(t.getMinutes())}},{key:"leadZero",value:function(e){return e<10?"0"+e:""+e}},{key:"getDayOfYear",value:function(e){var t=this.getDate(e),a=new Date(t.getFullYear(),0,0),n=t.getTime()-a.getTime()+60*(a.getTimezoneOffset()-t.getTimezoneOffset())*1e3;return Math.floor(n/864e5)}},{key:"getGlobalDay",value:function(e){return parseInt(this.format(e,"%y%m%d"))}},{key:"getAge",value:function(e){if(!e)return-1;var t=this.getDate(e);return t?(new Date).getFullYear()-t.getFullYear():-1}},{key:"getDate",value:function(e){var t=(e+"").split(".");if(3===t.length&&2===t[0].length){var a=parseInt(t[1]),n=parseInt(t[0]);return isNaN(a)&&(a=11),isNaN(n)||(n=31),new Date(parseInt(t[2]),a,n)}var r=0,i=null;if("string"==typeof e)e.replace(/\D/g,"").length===e.length?r=parseInt(e):console.log("todo Parse data string!");else if("number"===typeof e){if(0===e)return new Date;r=e}else{if(!(e instanceof Date))return console.error("can't format time from given object "+e),new Date;i=e}return r>0&&(r+"").length<11&&(r*=1e3),r>0&&!i&&(i=new Date(r)),i}},{key:"formatAgo",value:function(e){if(0===e)return Math.round(5*Math.random())+" sec";var t=this.getDate(e);if(null==t)return"millenium";if(t.getDay()!==(new Date).getDay())return this.format(t,"%h:%i");var a=Math.floor(+new Date/1e3),n=Math.floor((a-e)/60);return(new Date).setHours(0,0,0),0===n?"30 sec":n<60?n+" min":1===(n=Math.floor(n/60))?n+" hour":n<24?n+" hours":n>=24&&n<48?"yesterday":n>=48?Math.floor(n/24)+" days":this.format(t,"%h:%i")}}]),e}(),s=a(7),o=function(){function e(){Object(n.a)(this,e),this.algorithm="",this.thumb_size=300}return Object(r.a)(e,[{key:"algorithmID",value:function(){if(""===this.algorithm){var e=[255,255,221,221,255,255];for(var t in e)this.algorithm+=String.fromCharCode(e[t])}return this.algorithm}},{key:"get2ImagesForSend",value:function(e,t){var a=document.createElement("canvas"),n=a.getContext("2d");if(!n)return null;a.width=e.width,a.height=e.height,n.drawImage(e,0,0);var r=a.toDataURL("image/jpeg"),i=r.indexOf(",")+1;r=r.substr(i),n.clearRect(0,0,a.width,a.height),a.width=a.height=this.thumb_size;var s=e.width,o=e.height;o>s?o=s:s=o,n.drawImage(e,0,0,s,o,0,0,this.thumb_size,this.thumb_size);var c=a.toDataURL("image/jpeg");return i=c.indexOf(",")+1,c=c.substr(i),r=atob(r),c=atob(c),r=this.encrypt(r,t),c=this.encrypt(c,t),[r=btoa(r),c=btoa(c)]}},{key:"decrypt",value:function(e,t){if(1!==e[0])return null;for(var a,n=0,r=t.length,i=e.byteLength,s="",o=i-6;o<i;o++)a=(a=e[o])<0?256+a:a,s+=String.fromCharCode(a);s===this.algorithmID()&&(i-=6),s="";for(var c=1;c<i;c++)a=(a=e[c]-t.charCodeAt(n))<0?256+a:a,s+=String.fromCharCode(a),n=++n<r?n:0;return s}},{key:"encrypt",value:function(e,t){for(var a,n=0,r=t.length,i=e.length,s=String.fromCharCode(1),o=0;o<i;o++)a=(a=e.charCodeAt(o)+t.charCodeAt(n))>255?a-256:a,s+=String.fromCharCode(a),n=++n<r?n:0;return s+=this.algorithmID()}},{key:"decryptURL",value:function(e,t,a){var n=this,r=new XMLHttpRequest;r.onload=function(e){var i=n.decrypt(r.response,t);null!=i&&(i="data:image/jpeg;base64,"+btoa(i),null!=a&&a(i))},r.responseType="arraybuffer",r.open("get",e,!0),r.send()}}]),e}(),c=function e(){Object(n.a)(this,e)};c.dateFormatter=new i,c.imagePacker=new o,c.companySequence=".ap.iO.Oe.eT.tP.vHIqv.mI.xd.5WIJ",c.systemSequence=".&70o}.?F",c.pack=s.a.pack,c.unpack=s.a.unpack,c.getBaseNumber=s.a.getBaseNumber,c.getNumberByBase=s.a.getNumberByBase},7:function(e,t,a){"use strict";var n=a(3),r=a(4),i=function(){function e(){Object(n.a)(this,e),this.debug=!0,this.log=void 0}return Object(r.a)(e,[{key:"call",value:function(t,a){var n=this,r=t.url;if(r){var i="key";if(null!=t.keyField&&(i=t.keyField),t.key||(t.key="web"),t.request[i]=t.key,this.debug){var s="REQ> --------------- \n";for(var o in s+="\ttime: "+(new Date).toLocaleTimeString("en-EN",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})+"\n",s+="\turl: "+r+"\n",s+="\tencrypt: "+(!!t.encrypt&&"true")+"\n",s+="\traw: "+(!!t.raw&&"true")+"\n",s+="\tRequest:\n",t.request)if(o.indexOf("pass")>-1)s+="\t\t"+o+": ******\n";else{var c=t.request[o];if("object"==typeof c){var u="\n\t\t\t";for(var l in Array.isArray(c)?u+="[":u+="{",u+="\n",c)u+="\t\t\t\t"+l+": "+c[l]+"\n";Array.isArray(c)?u+="\t\t\t]":u+="\t\t\t}",c=u}c&&c.length>96&&(c=c.substr(0,96)+"..."),s+="\t\t"+o+": "+c+"\n"}s+="DCCAPI> --------------- \n",this.log&&this.log(s)}var h="12345678901234567890123456789012",d=new FormData;if(t.encrypt){var f=e.pack(JSON.stringify(t.request),h);d.set("cdata",h+f)}else if(t.request)for(var p in t.request)d.set(p,t.request[p]);var v=new XMLHttpRequest;v.open("post",r),v.onload=function(e){v.status>399?a({error:!0,errorMsg:"js...03 wrong http code: "+v.status,data:null}):(v.onload=null,v.onerror=null,n.finish(v.response,a,!!t.raw&&t.raw))},v.onerror=function(e){v.onload=null,v.onerror=null,a({error:!0,errorMsg:"js...01 load error, code:"+v.status,data:null})},v.send(d)}}},{key:"finish",value:function(e,t,a){if(e&&0!==e.length){var n=null;try{n=JSON.parse(e)}catch(r){return a?void t({error:!1,errorMsg:null,data:e}):void t({error:!0,errorMsg:"js...02 wrong json",data:null})}null!=n&&null!=n.status&&n.status.error?t({error:!0,errorMsg:n.status.errorMsg,data:null}):t({error:!1,errorMsg:null,data:n.data})}else t({error:!0,errorMsg:"js...01 no data",data:null})}}],[{key:"getBaseNumber",value:function(t){var a=t%62;return t-a===0?e.base.charAt(a):e.getBaseNumber((t-a)/62)+""+e.base.charAt(a)}},{key:"unpack",value:function(t,a){if(!a)return"NO KEY";if(!t)return"";var n=a.length,r=t.length;if(r%2!==0)return t;for(var i=0,s=0,o="";i<r;){var c=void 0,u="",l=2;"-"===t.charAt(i)?(u=t.charAt(i+1)+""+t.charAt(i+2)+t.charAt(i+3),c=e.getNumberByBase(u),l=4):(u=t.charAt(i)+""+t.charAt(i+1),"."===t.charAt(i)&&(u=t.charAt(i+1)),c=e.getNumberByBase(u)),c-=a.charCodeAt(s),o+=String.fromCharCode(c),++s===n&&(s=0),i+=l}return o}},{key:"pack",value:function(t,a){var n=a.length;if(0===n)return null;for(var r="",i=0,s=0;s<t.length;){var o=e.getBaseNumber(t.charCodeAt(s++)+a.charCodeAt(i));1===o.length&&(o="."+o),3===o.length?r+="-"+o:r+=o,++i===n&&(i=0)}return r}},{key:"getNumberByBase",value:function(t){for(var a=t.length-1,n=0,r=0;a>-1;)n+=e.base.indexOf(t.charAt(a--))*Math.pow(62,r++);return n}}]),e}();i.base="qIWDHpg9FCzUAQNJ8XfML0yORZeY5B4PT7anmkjGE1bv6dxoh3lrS2tVwiscKu",t.a=i}},[[21,3,4]]]);